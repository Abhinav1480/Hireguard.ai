import { useState, useEffect, useRef, useCallback } from "react";
import {
  AreaChart, Area, LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
  RadarChart, Radar, PolarGrid, PolarAngleAxis,
  XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend, ReferenceLine
} from "recharts";
import {
  LayoutDashboard, Brain, FileText, Target, TrendingUp, FileBarChart,
  Settings, Shield, Bell, LogOut, ChevronRight, AlertTriangle,
  CheckCircle, Upload, Download, Trash2, Search, Plus,
  Eye, EyeOff, Mail, Lock, Users, Activity,
  X, Zap, Cpu, FileSearch, XCircle, Save, Radio,
  HelpCircle, Info, Lightbulb, BarChart2, UserCheck,
  Flame, ChevronDown, ChevronUp, ArrowRight, Microscope,
  ScanLine, Radar as RadarIcon, PanelRight
} from "lucide-react";

// ─── CONSTANTS ────────────────────────────────────────────────────────────────
const API_BASE = "http://localhost:5000/api";

const DEMO_TRANSCRIPT = `Interviewer: So tell me about yourself. How old are you exactly?
Candidate: I'm Sarah, 34, with 8 years in product management.
Interviewer: Are you planning to have children soon? That might affect availability.
Candidate: I prefer to keep that private.
Interviewer: Where are you originally from? Your name sounds foreign.
Candidate: I'm from Chicago, born and raised.
Interviewer: Our team is mostly young guys who work late. What religion are you? We have Friday events.
Candidate: I'd rather not say.
Interviewer: We need someone without family distractions. Can you commit fully?`;

const DEMO_RESUME = `PROFESSIONAL SUMMARY
Results-driven professional leveraging synergies to orchestrate cross-functional initiatives and spearhead transformative solutions. Adept at utilizing cutting-edge methodologies to drive impactful outcomes.

EXPERIENCE
Senior Product Manager | TechCorp | 2020–Present
• Spearheaded development of innovative product roadmaps aligned with strategic objectives
• Orchestrated cross-departmental collaboration to streamline processes and enhance efficiency
• Leveraged data-driven insights to optimize user engagement and drive meaningful growth

SKILLS
Strategic Planning | Cross-functional Leadership | Data Analysis | Agile/Scrum | Stakeholder Management`;

// ─── MOCK DATA ────────────────────────────────────────────────────────────────
const MOCK_TREND = [
  { week: "W1", bias: 68, fraud: 42, risk: 72 },
  { week: "W2", bias: 72, fraud: 55, risk: 75 },
  { week: "W3", bias: 58, fraud: 38, risk: 61 },
  { week: "W4", bias: 45, fraud: 29, risk: 49 },
  { week: "W5", bias: 52, fraud: 33, risk: 55 },
  { week: "W6", bias: 38, fraud: 21, risk: 42 },
  { week: "W7", bias: 31, fraud: 18, risk: 34 },
  { week: "W8", bias: 28, fraud: 15, risk: 30 },
];

const MOCK_DEPT = [
  { dept: "Engineering", score: 42, count: 28 },
  { dept: "Sales", score: 68, count: 15 },
  { dept: "HR", score: 22, count: 12 },
  { dept: "Design", score: 35, count: 9 },
  { dept: "Operations", score: 51, count: 20 },
  { dept: "Legal", score: 18, count: 7 },
];

const MOCK_INTERVIEWS = [
  { _id: "1", recruiterName: "Alex Chen", department: "Engineering", candidateName: "Jordan Smith", biasScore: 18, riskLevel: "Low", status: "Reviewed", createdAt: new Date(Date.now() - 86400000 * 1).toISOString() },
  { _id: "2", recruiterName: "Maria Santos", department: "Sales", candidateName: "Priya Patel", biasScore: 62, riskLevel: "High", status: "Pending", createdAt: new Date(Date.now() - 86400000 * 2).toISOString() },
  { _id: "3", recruiterName: "James Patel", department: "Operations", candidateName: "Chris Lee", biasScore: 45, riskLevel: "Moderate", status: "Pending", createdAt: new Date(Date.now() - 86400000 * 3).toISOString() },
  { _id: "4", recruiterName: "Sarah Kim", department: "HR", candidateName: "Mohammed Ali", biasScore: 78, riskLevel: "Critical", status: "Pending", createdAt: new Date(Date.now() - 86400000 * 4).toISOString() },
  { _id: "5", recruiterName: "David Wu", department: "Design", candidateName: "Emma Wilson", biasScore: 12, riskLevel: "Low", status: "Reviewed", createdAt: new Date(Date.now() - 86400000 * 5).toISOString() },
];

const MOCK_RESUMES = [
  { _id: "1", candidateName: "Jordan Smith", position: "Sr. Engineer", aiProbabilityScore: 82, classification: "Almost Certainly AI", status: "Flagged", createdAt: new Date(Date.now() - 86400000).toISOString() },
  { _id: "2", candidateName: "Emma Wilson", position: "UX Designer", aiProbabilityScore: 23, classification: "Likely Human", status: "Cleared", createdAt: new Date(Date.now() - 86400000 * 2).toISOString() },
  { _id: "3", candidateName: "Marcus Brown", position: "PM", aiProbabilityScore: 55, classification: "Mixed", status: "Pending", createdAt: new Date(Date.now() - 86400000 * 3).toISOString() },
];

const MOCK_USERS = [
  { _id: "1", name: "Admin User", email: "admin@hireguard.ai", role: "Admin", department: "Platform", isActive: true, lastLogin: new Date().toISOString() },
  { _id: "2", name: "HR Manager", email: "hr@hireguard.ai", role: "HR", department: "Human Resources", isActive: true, lastLogin: new Date(Date.now() - 86400000).toISOString() },
  { _id: "3", name: "Auditor", email: "audit@hireguard.ai", role: "Auditor", department: "Compliance", isActive: true, lastLogin: new Date(Date.now() - 86400000 * 2).toISOString() },
];

// Recruiter analytics mock data
const MOCK_RECRUITERS = [
  { name: "Alex Chen", dept: "Engineering", sessions: [
    { week: "W1", score: 28 }, { week: "W2", score: 22 }, { week: "W3", score: 19 }, { week: "W4", score: 15 },
    { week: "W5", score: 18 }, { week: "W6", score: 12 }, { week: "W7", score: 10 }, { week: "W8", score: 8 },
  ], totalAudits: 18, avgBias: 16 },
  { name: "Emma Wilson", dept: "Design", sessions: [
    { week: "W1", score: 32 }, { week: "W2", score: 29 }, { week: "W3", score: 25 }, { week: "W4", score: 22 },
    { week: "W5", score: 21 }, { week: "W6", score: 19 }, { week: "W7", score: 21 }, { week: "W8", score: 19 },
  ], totalAudits: 11, avgBias: 24 },
  { name: "James Park", dept: "Operations", sessions: [
    { week: "W1", score: 38 }, { week: "W2", score: 42 }, { week: "W3", score: 35 }, { week: "W4", score: 38 },
    { week: "W5", score: 36 }, { week: "W6", score: 34 }, { week: "W7", score: 35 }, { week: "W8", score: 33 },
  ], totalAudits: 20, avgBias: 36 },
  { name: "Maria Santos", dept: "Sales", sessions: [
    { week: "W1", score: 45 }, { week: "W2", score: 58 }, { week: "W3", score: 62 }, { week: "W4", score: 55 },
    { week: "W5", score: 60 }, { week: "W6", score: 58 }, { week: "W7", score: 64 }, { week: "W8", score: 61 },
  ], totalAudits: 15, avgBias: 58 },
  { name: "Sarah Kim", dept: "HR", sessions: [
    { week: "W1", score: 72 }, { week: "W2", score: 78 }, { week: "W3", score: 71 }, { week: "W4", score: 82 },
    { week: "W5", score: 76 }, { week: "W6", score: 80 }, { week: "W7", score: 75 }, { week: "W8", score: 77 },
  ], totalAudits: 9, avgBias: 76 },
  { name: "David Wu", dept: "Legal", sessions: [
    { week: "W1", score: 18 }, { week: "W2", score: 15 }, { week: "W3", score: 14 }, { week: "W4", score: 12 },
    { week: "W5", score: 11 }, { week: "W6", score: 13 }, { week: "W7", score: 10 }, { week: "W8", score: 9 },
  ], totalAudits: 7, avgBias: 13 },
];

const HEATMAP_DATA = [
  { recruiter: "Alex Chen", Engineering: 16, Sales: null, HR: null, Design: null, Operations: null, Legal: null },
  { recruiter: "Emma Wilson", Engineering: null, Sales: null, HR: null, Design: 24, Operations: null, Legal: null },
  { recruiter: "James Park", Engineering: null, Sales: null, HR: null, Design: null, Operations: 36, Legal: null },
  { recruiter: "Maria Santos", Engineering: null, Sales: 58, HR: null, Design: null, Operations: null, Legal: null },
  { recruiter: "Sarah Kim", Engineering: null, Sales: null, HR: 76, Design: null, Operations: null, Legal: null },
  { recruiter: "David Wu", Engineering: null, Sales: null, HR: null, Design: null, Operations: null, Legal: 13 },
];

const DEPARTMENTS = ["Engineering", "Sales", "HR", "Design", "Operations", "Legal"];

// ─── THEME ────────────────────────────────────────────────────────────────────
const COLORS = {
  risk: { low: "#10b981", moderate: "#f59e0b", high: "#ef4444", critical: "#dc2626" },
  chart: ["#6366f1", "#8b5cf6", "#06b6d4", "#10b981", "#f59e0b", "#ef4444"]
};

const riskColor = (score) => score < 25 ? COLORS.risk.low : score < 50 ? COLORS.risk.moderate : score < 75 ? COLORS.risk.high : COLORS.risk.critical;
const riskLabel = (score) => score < 25 ? "Low Risk" : score < 50 ? "Moderate" : score < 75 ? "High Risk" : "Critical";
const riskFromLabel = (label) => ({ Low: COLORS.risk.low, Moderate: COLORS.risk.moderate, High: COLORS.risk.high, Critical: COLORS.risk.critical }[label] || "#94a3b8");

// ─── GLOBAL STYLES ────────────────────────────────────────────────────────────
const GLOBAL_CSS = `
  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body, #root { height: 100%; overflow: hidden; }
  body { font-family: 'Outfit', sans-serif; background: #0B1426; color: #e2e8f0; }

  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: rgba(15,23,42,0.5); }
  ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.4); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.7); }

  @keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  @keyframes pulseRed { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-6px); } }
  @keyframes numberUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
  @keyframes slideInRight { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
  @keyframes slideInLeft { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }
  @keyframes bounceIn { 0% { opacity:0; transform:scale(0.3); } 60% { transform:scale(1.05); } 80% { transform:scale(0.95); } 100% { opacity:1; transform:scale(1); } }
  @keyframes warningPulse { 0%,100% { border-color:rgba(239,68,68,0.4); box-shadow:0 0 0 0 rgba(239,68,68,0.2); } 50% { border-color:rgba(239,68,68,0.8); box-shadow:0 0 20px 4px rgba(239,68,68,0.15); } }
  @keyframes scanLine { 0% { transform:translateY(-100%); } 100% { transform:translateY(400%); } }
  @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0; } }
  @keyframes heatGlow { 0%,100% { filter:brightness(1); } 50% { filter:brightness(1.3); } }
  @keyframes panelSlide { from { opacity:0; transform:translateX(100%); } to { opacity:1; transform:translateX(0); } }
  @keyframes panelSlideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
  @keyframes ripple { 0% { transform:scale(0); opacity:1; } 100% { transform:scale(4); opacity:0; } }
  @keyframes gradientFlow { 0% { background-position:0% 50%; } 50% { background-position:100% 50%; } 100% { background-position:0% 50%; } }

  .fade-up { animation: fadeUp 0.4s ease forwards; }
  .fade-in { animation: fadeIn 0.3s ease forwards; }
  .scale-in { animation: scaleIn 0.3s ease forwards; }
  .spin { animation: spin 1s linear infinite; }
  .pulse { animation: pulse 2s ease infinite; }
  .float { animation: float 3s ease-in-out infinite; }
  .bounce-in { animation: bounceIn 0.5s cubic-bezier(0.36,0.07,0.19,0.97) forwards; }
  .slide-in-right { animation: slideInRight 0.35s cubic-bezier(0.16,1,0.3,1) forwards; }
  .slide-in-left { animation: slideInLeft 0.3s ease forwards; }
  .panel-slide { animation: panelSlide 0.4s cubic-bezier(0.16,1,0.3,1) forwards; }
  .panel-slide-up { animation: panelSlideUp 0.3s ease forwards; }

  .glass {
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(99,102,241,0.12);
  }
  .glass-bright {
    background: rgba(30, 41, 59, 0.8);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(99,102,241,0.2);
  }
  .card {
    background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95));
    border: 1px solid rgba(99,102,241,0.15);
    border-radius: 12px;
    transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
  }
  .card:hover { border-color: rgba(99,102,241,0.35); }
  .card-elevated:hover { transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
  .card-warning {
    background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(15,23,42,0.95));
    border: 1px solid rgba(239,68,68,0.35);
    animation: warningPulse 2s ease infinite;
  }
  .card-live {
    background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(15,23,42,0.95));
    border: 1px solid rgba(99,102,241,0.3);
    box-shadow: 0 0 20px rgba(99,102,241,0.08);
  }

  .btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; cursor: pointer;
    font-family: 'Outfit', sans-serif; font-weight: 600;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99,102,241,0.4); filter: brightness(1.1); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: rgba(30,41,59,0.8); color: #94a3b8;
    border: 1px solid rgba(99,102,241,0.2); cursor: pointer;
    font-family: 'Outfit', sans-serif; font-weight: 500;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-secondary:hover { background: rgba(51,65,85,0.8); color: #e2e8f0; border-color: rgba(99,102,241,0.4); }

  .btn-danger {
    background: rgba(239,68,68,0.1); color: #fca5a5;
    border: 1px solid rgba(239,68,68,0.3); cursor: pointer;
    font-family: 'Outfit', sans-serif; font-weight: 500;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-danger:hover { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.5); }

  .btn-success {
    background: rgba(16,185,129,0.1); color: #6ee7b7;
    border: 1px solid rgba(16,185,129,0.3); cursor: pointer;
    font-family: 'Outfit', sans-serif; font-weight: 500;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-success:hover { background: rgba(16,185,129,0.2); }

  .btn-explain {
    background: rgba(139,92,246,0.1); color: #c4b5fd;
    border: 1px solid rgba(139,92,246,0.3); cursor: pointer;
    font-family: 'Outfit', sans-serif; font-weight: 500;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 10px; border-radius: 7px; font-size: 12px;
  }
  .btn-explain:hover { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.5); transform: translateX(2px); }

  .input {
    background: rgba(15,23,42,0.8); border: 1px solid rgba(99,102,241,0.2);
    color: #e2e8f0; font-family: 'Outfit', sans-serif;
    transition: border-color 0.2s, box-shadow 0.2s; outline: none;
  }
  .input:focus { border-color: rgba(99,102,241,0.6); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
  .input::placeholder { color: rgba(148,163,184,0.4); }
  .input-live {
    background: rgba(99,102,241,0.05) !important;
    border-color: rgba(99,102,241,0.4) !important;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.08), 0 0 20px rgba(99,102,241,0.05) !important;
  }
  .input-live:focus {
    border-color: rgba(99,102,241,0.7) !important;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.15), 0 0 25px rgba(99,102,241,0.08) !important;
  }

  .sidebar-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; border-radius: 8px; cursor: pointer;
    transition: all 0.15s; color: #64748b; font-size: 13.5px; font-weight: 500;
    border: 1px solid transparent; white-space: nowrap;
  }
  .sidebar-item:hover { background: rgba(99,102,241,0.08); color: #a5b4fc; }
  .sidebar-item.active {
    background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.15));
    color: #a5b4fc; border-color: rgba(99,102,241,0.3);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
  }

  .table { width: 100%; border-collapse: collapse; }
  .table th { padding: 10px 14px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: #64748b; border-bottom: 1px solid rgba(99,102,241,0.15); background: rgba(15,23,42,0.5); }
  .table td { padding: 11px 14px; font-size: 13px; border-bottom: 1px solid rgba(99,102,241,0.07); color: #cbd5e1; }
  .table tr:hover td { background: rgba(99,102,241,0.04); }
  .table tr:last-child td { border-bottom: none; }

  .badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 600;
    font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 0.04em;
  }
  .badge-low { background: rgba(16,185,129,0.12); color: #10b981; border: 1px solid rgba(16,185,129,0.25); }
  .badge-moderate { background: rgba(245,158,11,0.12); color: #f59e0b; border: 1px solid rgba(245,158,11,0.25); }
  .badge-high { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
  .badge-critical { background: rgba(220,38,38,0.2); color: #fca5a5; border: 1px solid rgba(220,38,38,0.4); }
  .badge-pending { background: rgba(148,163,184,0.1); color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }
  .badge-reviewed { background: rgba(16,185,129,0.1); color: #10b981; border: 1px solid rgba(16,185,129,0.25); }
  .badge-flagged { background: rgba(239,68,68,0.1); color: #ef4444; border: 1px solid rgba(239,68,68,0.25); }
  .badge-cleared { background: rgba(16,185,129,0.1); color: #10b981; border: 1px solid rgba(16,185,129,0.25); }
  .badge-improving { background: rgba(16,185,129,0.12); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
  .badge-worsening { background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
  .badge-stable { background: rgba(148,163,184,0.1); color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }

  .tab-btn { padding: 7px 16px; border-radius: 7px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; font-family: 'Outfit', sans-serif; }
  .tab-btn.active { background: rgba(99,102,241,0.2); color: #a5b4fc; border-color: rgba(99,102,241,0.35); }
  .tab-btn:not(.active) { color: #64748b; background: transparent; }
  .tab-btn:not(.active):hover { color: #94a3b8; background: rgba(99,102,241,0.06); }

  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; }
  .modal { background: #0f172a; border: 1px solid rgba(99,102,241,0.25); border-radius: 16px; max-height: 90vh; overflow-y: auto; animation: scaleIn 0.2s ease; }

  .section-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: #475569; margin-bottom: 12px; font-family: 'JetBrains Mono', monospace; }
  .metric-value { font-family: 'JetBrains Mono', monospace; font-weight: 600; animation: numberUp 0.5s ease; }
  .risk-bar { height: 6px; border-radius: 3px; background: rgba(30,41,59,0.8); overflow: hidden; }
  .risk-bar-fill { height: 100%; border-radius: 3px; transition: width 1s cubic-bezier(0.4,0,0.2,1); }
  .gradient-text { background: linear-gradient(135deg, #6366f1, #8b5cf6, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .notification-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; position: absolute; top: -2px; right: -2px; animation: pulse 2s infinite; }
  .drag-zone { border: 2px dashed rgba(99,102,241,0.3); border-radius: 12px; padding: 40px; text-align: center; transition: all 0.2s; cursor: pointer; }
  .drag-zone:hover, .drag-zone.dragging { border-color: rgba(99,102,241,0.6); background: rgba(99,102,241,0.06); }
  .score-ring { transform: rotate(-90deg); }
  .score-track { fill: none; stroke: rgba(30,41,59,0.8); stroke-width: 8; }
  .score-fill { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1.5s cubic-bezier(0.4,0,0.2,1); }
  .tooltip-custom { background: rgba(15,23,42,0.97) !important; border: 1px solid rgba(99,102,241,0.3) !important; border-radius: 10px !important; font-family: 'JetBrains Mono', monospace !important; font-size: 11px !important; }
  textarea.input { resize: vertical; min-height: 120px; }
  select.input { appearance: none; }

  /* Live monitoring text highlighting */
  .text-highlight-bias { background: rgba(239,68,68,0.2); border-bottom: 2px solid #ef4444; color: #fca5a5; border-radius: 2px; padding: 0 1px; }
  
  /* Bias warning floating popup */
  .bias-popup { animation: bounceIn 0.4s cubic-bezier(0.36,0.07,0.19,0.97) forwards; }

  /* Explain panel */
  .explain-panel {
    position: fixed; right: 0; top: 56px; bottom: 0; width: 400px;
    background: linear-gradient(180deg, rgba(15,13,36,0.98) 0%, rgba(10,18,34,0.99) 100%);
    border-left: 1px solid rgba(139,92,246,0.3);
    box-shadow: -20px 0 60px rgba(0,0,0,0.5);
    z-index: 80; overflow-y: auto;
    animation: panelSlide 0.4s cubic-bezier(0.16,1,0.3,1) forwards;
  }
  .explain-panel-overlay {
    position: fixed; inset: 0; z-index: 79;
    background: rgba(0,0,0,0.2); backdrop-filter: blur(1px);
  }

  /* Compliance risk meter animated arc */
  .compliance-arc { transform: rotate(-90deg); transform-origin: center; }

  /* Live scanning animation */
  .scan-overlay { position: absolute; inset: 0; pointer-events: none; overflow: hidden; border-radius: 10px; }
  .scan-line { position: absolute; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(99,102,241,0.6), transparent); animation: scanLine 2s linear infinite; }

  /* Heatmap cells */
  .heatmap-cell { border-radius: 6px; transition: all 0.2s; cursor: default; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 12px; }
  .heatmap-cell:hover { transform: scale(1.1); z-index: 2; }

  /* Trend direction indicators */
  .trend-improving { color: #10b981; }
  .trend-worsening { color: #ef4444; }
  .trend-stable { color: #94a3b8; }

  /* Toggle switch */
  .toggle-track { width: 46px; height: 26px; border-radius: 13px; cursor: pointer; transition: all 0.25s; position: relative; border: none; }
  .toggle-thumb { position: absolute; width: 20px; height: 20px; border-radius: 50%; background: white; top: 3px; transition: all 0.25s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
  .toggle-live { background: linear-gradient(135deg, #6366f1, #8b5cf6); box-shadow: 0 0 16px rgba(99,102,241,0.5); }
  .toggle-off { background: rgba(30,41,59,0.8); }

  /* Live indicator dot */
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 1.5s ease infinite; box-shadow: 0 0 8px rgba(16,185,129,0.6); }

  /* Warning red dot */  
  .warn-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; animation: pulse 1s ease infinite; box-shadow: 0 0 8px rgba(239,68,68,0.8); }
`;

// ─── UTILITY COMPONENTS ───────────────────────────────────────────────────────
const Spinner = ({ size = 16 }) => (
  <div className="spin" style={{ width: size, height: size, border: `2px solid rgba(99,102,241,0.3)`, borderTopColor: "#6366f1", borderRadius: "50%" }} />
);

const ScoreRing = ({ score, size = 100, strokeW = 8 }) => {
  const r = (size - strokeW * 2) / 2;
  const circ = 2 * Math.PI * r;
  const offset = circ - (score / 100) * circ;
  const color = riskColor(score);
  return (
    <div style={{ position: "relative", width: size, height: size }}>
      <svg width={size} height={size} className="score-ring">
        <circle cx={size/2} cy={size/2} r={r} className="score-track" strokeWidth={strokeW} />
        <circle cx={size/2} cy={size/2} r={r} className="score-fill" stroke={color}
          strokeWidth={strokeW} strokeDasharray={circ} strokeDashoffset={offset}
          style={{ filter: `drop-shadow(0 0 6px ${color}80)` }} />
      </svg>
      <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
        <span style={{ fontSize: size * 0.22, fontWeight: 700, color, fontFamily: "JetBrains Mono" }}>{score}</span>
        <span style={{ fontSize: size * 0.1, color: "#64748b", fontFamily: "JetBrains Mono" }}>/100</span>
      </div>
    </div>
  );
};

const MetricCard = ({ icon: Icon, label, value, sub, color = "#6366f1", trend, delay = 0 }) => (
  <div className="card card-elevated fade-up" style={{ padding: 20, animationDelay: `${delay}s` }}>
    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 14 }}>
      <div style={{ width: 38, height: 38, borderRadius: 10, background: `${color}20`, border: `1px solid ${color}35`, display: "flex", alignItems: "center", justifyContent: "center" }}>
        <Icon size={17} style={{ color }} />
      </div>
      {trend !== undefined && (
        <span style={{ fontSize: 12, fontWeight: 600, color: trend > 0 ? "#ef4444" : "#10b981", fontFamily: "JetBrains Mono" }}>
          {trend > 0 ? "↑" : "↓"}{Math.abs(trend)}%
        </span>
      )}
    </div>
    <div className="metric-value" style={{ fontSize: 28, color: "white", marginBottom: 4 }}>{value}</div>
    <div style={{ fontSize: 13, color: "#64748b" }}>{label}</div>
    {sub && <div style={{ fontSize: 11, color, marginTop: 4, fontWeight: 500 }}>{sub}</div>}
  </div>
);

const Badge = ({ level, label }) => {
  const cls = `badge badge-${level?.toLowerCase().replace(/\s+/g, "-") || "pending"}`;
  return <span className={cls}>{label || level}</span>;
};

const TooltipContent = ({ active, payload, label }) => {
  if (!active || !payload?.length) return null;
  return (
    <div className="tooltip-custom" style={{ padding: "8px 12px" }}>
      <p style={{ color: "#94a3b8", marginBottom: 6 }}>{label}</p>
      {payload.map((p, i) => (
        <p key={i} style={{ color: p.color, fontSize: 12 }}>{p.name}: <span style={{ color: "white", fontWeight: 600 }}>{p.value}</span></p>
      ))}
    </div>
  );
};

const SectionHeader = ({ title, children }) => (
  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
    <h2 style={{ fontSize: 18, fontWeight: 700, color: "white" }}>{title}</h2>
    <div style={{ display: "flex", gap: 8 }}>{children}</div>
  </div>
);

// ─── LIVE COMPLIANCE METER ────────────────────────────────────────────────────
const ComplianceMeter = ({ score }) => {
  const r = 54, circ = 2 * Math.PI * r;
  const fill = circ - (score / 100) * circ;
  const color = riskColor(score);
  return (
    <div style={{ display: "flex", flexDirection: "column", alignItems: "center", gap: 6 }}>
      <div style={{ position: "relative", width: 130, height: 130 }}>
        <svg width={130} height={130} style={{ transform: "rotate(-90deg)" }}>
          <circle cx={65} cy={65} r={r} fill="none" stroke="rgba(30,41,59,0.8)" strokeWidth={10} />
          <circle cx={65} cy={65} r={r} fill="none" stroke={color} strokeWidth={10}
            strokeLinecap="round" strokeDasharray={circ} strokeDashoffset={fill}
            style={{ transition: "stroke-dashoffset 0.8s cubic-bezier(0.4,0,0.2,1), stroke 0.5s ease", filter: `drop-shadow(0 0 8px ${color}80)` }} />
        </svg>
        <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
          <span style={{ fontSize: 26, fontWeight: 800, color, fontFamily: "JetBrains Mono", lineHeight: 1 }}>{score}</span>
          <span style={{ fontSize: 10, color: "#475569", fontFamily: "JetBrains Mono" }}>RISK</span>
        </div>
      </div>
      <span style={{ fontSize: 11, fontWeight: 600, color, fontFamily: "JetBrains Mono" }}>{riskLabel(score)}</span>
    </div>
  );
};

// ─── EXPLAINABILITY PANEL ─────────────────────────────────────────────────────
const ExplainPanel = ({ item, type, onClose }) => {
  const [loading, setLoading] = useState(true);
  const [explanation, setExplanation] = useState(null);

  useEffect(() => {
    const fetch_explanation = async () => {
      setLoading(true);
      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 800,
            system: `You are an AI transparency expert explaining bias detection decisions clearly to HR professionals.
Respond ONLY with valid JSON:
{
  "explanation": "1-2 sentence plain English explanation of why this was flagged",
  "contextBreakdown": ["context point 1", "context point 2", "context point 3"],
  "triggerKeywords": ["word1", "word2", "word3"],
  "confidenceScore": 0-100,
  "riskLogic": "explanation of the risk scoring logic used",
  "reasoningSummary": "structured 2-3 sentence model reasoning",
  "falsePosNote": "caution note about potential false positive scenarios"
}`,
            messages: [{ role: "user", content: `Explain why this ${type} was flagged:\n\nFlagged content: "${item.text || item.flag || JSON.stringify(item)}"\nType: ${item.biasType || type}\nSeverity: ${item.severity || "moderate"}\n\nProvide full explainability breakdown.` }]
          })
        });
        const data = await response.json();
        const txt = data.content?.map(b => b.text || "").join("") || "";
        setExplanation(JSON.parse(txt.replace(/```json\n?|```/g, "").trim()));
      } catch (e) {
        setExplanation({
          explanation: `This ${type === "bias" ? "phrase" : "content"} was flagged because it contains language patterns associated with ${item.biasType || "potential bias"} in hiring contexts.`,
          contextBreakdown: [
            "The phrasing implies a preference or prejudice not relevant to job performance",
            "Similar language has historically led to discriminatory hiring patterns",
            "EEOC guidelines classify this type of inquiry as potentially unlawful"
          ],
          triggerKeywords: (item.text || "").split(" ").filter(w => w.length > 4).slice(0, 5),
          confidenceScore: Math.floor(Math.random() * 25) + 70,
          riskLogic: "The model evaluates semantic meaning, contextual intent, and legal precedent to calculate a risk score. Higher scores reflect stronger linguistic signals of discriminatory intent.",
          reasoningSummary: "The AI identified specific linguistic markers that correlate with biased interview practices. The combination of context and phrasing triggered the bias detection threshold. Similar patterns appear in documented cases of discriminatory hiring.",
          falsePosNote: "This may be a false positive if the question was asked in a clearly legal context (e.g., verifying work authorization). Review the surrounding conversation before taking action."
        });
      }
      setLoading(false);
    };
    fetch_explanation();
  }, [item]);

  const confColor = explanation ? riskColor(100 - explanation.confidenceScore) : "#94a3b8";

  return (
    <>
      <div className="explain-panel-overlay" onClick={onClose} />
      <div className="explain-panel">
        {/* Header */}
        <div style={{ padding: "20px 24px 16px", borderBottom: "1px solid rgba(139,92,246,0.2)", background: "linear-gradient(135deg, rgba(139,92,246,0.1), transparent)", position: "sticky", top: 0, backdropFilter: "blur(12px)", zIndex: 1 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 10 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 36, height: 36, borderRadius: 10, background: "rgba(139,92,246,0.2)", border: "1px solid rgba(139,92,246,0.4)", display: "flex", alignItems: "center", justifyContent: "center" }}>
                <Microscope size={17} style={{ color: "#c4b5fd" }} />
              </div>
              <div>
                <div style={{ fontSize: 15, fontWeight: 700, color: "white" }}>AI Explainability</div>
                <div style={{ fontSize: 11, color: "#64748b", fontFamily: "JetBrains Mono" }}>TRANSPARENCY MODULE</div>
              </div>
            </div>
            <button onClick={onClose} style={{ background: "none", border: "none", cursor: "pointer", color: "#475569", padding: 4, borderRadius: 6, transition: "color 0.2s" }}>
              <X size={16} />
            </button>
          </div>
          {/* Flagged item preview */}
          <div style={{ padding: "10px 12px", borderRadius: 8, background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.2)" }}>
            <div style={{ fontSize: 11, color: "#64748b", marginBottom: 4, fontFamily: "JetBrains Mono" }}>FLAGGED CONTENT</div>
            <div style={{ fontSize: 12, color: "#fca5a5", fontStyle: "italic" }}>"{(item.text || item.flag || "").slice(0, 100)}{(item.text || "").length > 100 ? "..." : ""}"</div>
            <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
              {item.biasType && <Badge level={item.biasType} label={item.biasType} />}
              {item.severity && <Badge level={item.severity} label={item.severity} />}
            </div>
          </div>
        </div>

        {loading ? (
          <div style={{ padding: 40, display: "flex", flexDirection: "column", alignItems: "center", gap: 16 }}>
            <div className="float"><Microscope size={36} style={{ color: "#8b5cf6" }} /></div>
            <div style={{ color: "#a5b4fc", fontSize: 13 }}>Generating explanation...</div>
            <div style={{ display: "flex", gap: 6 }}>
              {[0, 0.15, 0.3].map((d, i) => (
                <div key={i} className="pulse" style={{ width: 8, height: 8, borderRadius: "50%", background: "#8b5cf6", animationDelay: `${d}s` }} />
              ))}
            </div>
          </div>
        ) : explanation && (
          <div style={{ padding: "0 24px 24px" }}>

            {/* Confidence Score */}
            <div style={{ marginTop: 20, marginBottom: 20, padding: 16, borderRadius: 10, background: "rgba(15,23,42,0.6)", border: "1px solid rgba(139,92,246,0.15)" }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                <span style={{ fontSize: 12, color: "#64748b", fontFamily: "JetBrains Mono", fontWeight: 600, letterSpacing: "0.06em" }}>CONFIDENCE SCORE</span>
                <span style={{ fontSize: 22, fontWeight: 800, color: "#c4b5fd", fontFamily: "JetBrains Mono" }}>{explanation.confidenceScore}%</span>
              </div>
              <div style={{ height: 8, borderRadius: 4, background: "rgba(30,41,59,0.8)", overflow: "hidden" }}>
                <div style={{ height: "100%", borderRadius: 4, width: `${explanation.confidenceScore}%`, background: "linear-gradient(90deg, #8b5cf6, #6366f1)", boxShadow: "0 0 10px rgba(139,92,246,0.5)", transition: "width 1.5s ease" }} />
              </div>
            </div>

            {/* Explanation */}
            <div style={{ marginBottom: 16 }}>
              <div className="section-label">WHY WAS THIS FLAGGED?</div>
              <p style={{ fontSize: 13, color: "#cbd5e1", lineHeight: 1.7, padding: "10px 12px", borderRadius: 8, background: "rgba(99,102,241,0.06)", border: "1px solid rgba(99,102,241,0.12)" }}>
                {explanation.explanation}
              </p>
            </div>

            {/* Trigger Keywords */}
            <div style={{ marginBottom: 16 }}>
              <div className="section-label">TRIGGER KEYWORDS</div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                {(explanation.triggerKeywords || []).map((kw, i) => (
                  <span key={i} className="panel-slide-up" style={{ padding: "4px 10px", borderRadius: 6, background: "rgba(239,68,68,0.1)", border: "1px solid rgba(239,68,68,0.25)", color: "#fca5a5", fontSize: 12, fontFamily: "JetBrains Mono", animationDelay: `${i * 0.05}s` }}>
                    {kw}
                  </span>
                ))}
              </div>
            </div>

            {/* Context Breakdown */}
            <div style={{ marginBottom: 16 }}>
              <div className="section-label">CONTEXT ANALYSIS</div>
              <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                {(explanation.contextBreakdown || []).map((ctx, i) => (
                  <div key={i} className="slide-in-left" style={{ display: "flex", gap: 10, padding: "9px 12px", borderRadius: 8, background: "rgba(15,23,42,0.5)", border: "1px solid rgba(99,102,241,0.1)", animationDelay: `${i * 0.08}s` }}>
                    <div style={{ width: 6, height: 6, borderRadius: "50%", background: "#6366f1", marginTop: 5, flexShrink: 0 }} />
                    <span style={{ fontSize: 12, color: "#94a3b8", lineHeight: 1.5 }}>{ctx}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Risk Logic */}
            <div style={{ marginBottom: 16 }}>
              <div className="section-label">RISK SCORING LOGIC</div>
              <div style={{ padding: "12px 14px", borderRadius: 8, background: "rgba(245,158,11,0.06)", border: "1px solid rgba(245,158,11,0.15)" }}>
                <p style={{ fontSize: 12, color: "#fbbf24", lineHeight: 1.6 }}>{explanation.riskLogic}</p>
              </div>
            </div>

            {/* Model Reasoning */}
            <div style={{ marginBottom: 16 }}>
              <div className="section-label">MODEL REASONING SUMMARY</div>
              <div style={{ padding: "12px 14px", borderRadius: 8, background: "rgba(139,92,246,0.06)", border: "1px solid rgba(139,92,246,0.15)" }}>
                <p style={{ fontSize: 12, color: "#c4b5fd", lineHeight: 1.6 }}>{explanation.reasoningSummary}</p>
              </div>
            </div>

            {/* False Positive Note */}
            <div style={{ padding: "12px 14px", borderRadius: 8, background: "rgba(16,185,129,0.05)", border: "1px solid rgba(16,185,129,0.15)" }}>
              <div style={{ display: "flex", gap: 8, alignItems: "flex-start" }}>
                <Info size={14} style={{ color: "#10b981", flexShrink: 0, marginTop: 1 }} />
                <div>
                  <div style={{ fontSize: 11, color: "#10b981", fontFamily: "JetBrains Mono", fontWeight: 600, marginBottom: 4 }}>FALSE POSITIVE CAUTION</div>
                  <p style={{ fontSize: 12, color: "#6ee7b7", lineHeight: 1.5 }}>{explanation.falsePosNote}</p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </>
  );
};

// ─── BIAS WARNING POPUP ───────────────────────────────────────────────────────
const BiasWarningPopup = ({ warning, onDismiss, onExplain }) => {
  if (!warning) return null;
  const sevColor = { mild: "#f59e0b", moderate: "#ef4444", severe: "#dc2626" }[warning.severity] || "#ef4444";

  return (
    <div className="bias-popup" style={{
      position: "absolute", top: 12, right: 12, width: 320, zIndex: 30,
      background: "linear-gradient(135deg, rgba(15,10,30,0.98), rgba(25,15,40,0.98))",
      border: `1px solid rgba(239,68,68,0.5)`,
      borderRadius: 12, padding: "14px 16px",
      boxShadow: `0 8px 40px rgba(239,68,68,0.25), 0 0 0 1px rgba(239,68,68,0.1)`,
      animation: "bounceIn 0.4s cubic-bezier(0.36,0.07,0.19,0.97)"
    }}>
      <div style={{ display: "flex", alignItems: "flex-start", gap: 10, marginBottom: 10 }}>
        <div className="warn-dot" style={{ marginTop: 4, flexShrink: 0 }} />
        <div style={{ flex: 1 }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: "#fca5a5", marginBottom: 2 }}>
            ⚠ Potential Bias Detected
          </div>
          <div style={{ fontSize: 11, color: "#64748b" }}>Real-time monitoring alert</div>
        </div>
        <button onClick={onDismiss} style={{ background: "none", border: "none", cursor: "pointer", color: "#475569", padding: 2 }}>
          <X size={14} />
        </button>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, marginBottom: 10 }}>
        <div style={{ padding: "6px 10px", borderRadius: 7, background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.15)" }}>
          <div style={{ fontSize: 10, color: "#64748b", fontFamily: "JetBrains Mono", marginBottom: 2 }}>BIAS TYPE</div>
          <div style={{ fontSize: 12, color: "#fca5a5", fontWeight: 600 }}>{warning.bias_type || warning.biasType}</div>
        </div>
        <div style={{ padding: "6px 10px", borderRadius: 7, background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.15)" }}>
          <div style={{ fontSize: 10, color: "#64748b", fontFamily: "JetBrains Mono", marginBottom: 2 }}>SEVERITY</div>
          <div style={{ fontSize: 12, color: sevColor, fontWeight: 600, textTransform: "capitalize" }}>{warning.severity}</div>
        </div>
        <div style={{ padding: "6px 10px", borderRadius: 7, background: "rgba(99,102,241,0.08)", border: "1px solid rgba(99,102,241,0.15)", gridColumn: "1/-1" }}>
          <div style={{ fontSize: 10, color: "#64748b", fontFamily: "JetBrains Mono", marginBottom: 2 }}>CONFIDENCE</div>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <span style={{ fontSize: 15, color: "#a5b4fc", fontWeight: 700, fontFamily: "JetBrains Mono" }}>{warning.confidence}%</span>
            <div style={{ flex: 1, height: 4, borderRadius: 2, background: "rgba(30,41,59,0.8)" }}>
              <div style={{ height: "100%", borderRadius: 2, width: `${warning.confidence}%`, background: "linear-gradient(90deg, #6366f1, #8b5cf6)" }} />
            </div>
          </div>
        </div>
      </div>

      <div style={{ padding: "8px 10px", borderRadius: 7, background: "rgba(16,185,129,0.06)", border: "1px solid rgba(16,185,129,0.15)", marginBottom: 10 }}>
        <div style={{ fontSize: 10, color: "#10b981", fontFamily: "JetBrains Mono", marginBottom: 3 }}>SUGGESTED ALTERNATIVE</div>
        <p style={{ fontSize: 12, color: "#6ee7b7", lineHeight: 1.4 }}>{warning.suggestion}</p>
      </div>

      <div style={{ display: "flex", gap: 6 }}>
        <button className="btn-explain" onClick={() => onExplain(warning)} style={{ flex: 1, justifyContent: "center" }}>
          <Microscope size={11} /> Why Flagged?
        </button>
        <button onClick={onDismiss} className="btn-secondary" style={{ padding: "5px 10px", borderRadius: 7, fontSize: 12 }}>
          Dismiss
        </button>
      </div>
    </div>
  );
};

// ─── AUTH SCREEN ──────────────────────────────────────────────────────────────
const AuthScreen = ({ onLogin }) => {
  const [mode, setMode] = useState("login");
  const [form, setForm] = useState({ name: "Admin User", email: "admin@hireguard.ai", password: "password123", role: "Admin" });
  const [showPw, setShowPw] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const submit = async () => {
    setLoading(true); setError("");
    try {
      try {
        const endpoint = mode === "login" ? "/auth/login" : "/auth/register";
        const body = mode === "login" ? { email: form.email, password: form.password } : form;
        const res = await fetch(`${API_BASE}${endpoint}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
        const data = await res.json();
        if (data.success) { onLogin(data.token, data.user); return; }
        throw new Error(data.message);
      } catch (apiErr) {
        if (form.email && form.password) {
          onLogin("demo-token", { _id: "demo", name: form.name || "Demo User", email: form.email, role: form.role || "Admin", department: "Platform" });
          return;
        }
        throw new Error("Please enter email and password");
      }
    } catch (err) { setError(err.message); }
    setLoading(false);
  };

  return (
    <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "linear-gradient(135deg, #0B1426 0%, #0f172a 50%, #0B1426 100%)", padding: 20 }}>
      <div style={{ position: "fixed", inset: 0, pointerEvents: "none", overflow: "hidden" }}>
        <div style={{ position: "absolute", width: 600, height: 600, borderRadius: "50%", background: "radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%)", top: "10%", left: "20%", animation: "float 8s ease-in-out infinite" }} />
        <div style={{ position: "absolute", width: 400, height: 400, borderRadius: "50%", background: "radial-gradient(circle, rgba(139,92,246,0.06) 0%, transparent 70%)", bottom: "15%", right: "25%", animation: "float 10s ease-in-out infinite 2s" }} />
      </div>
      <div className="fade-up" style={{ width: 420, position: "relative" }}>
        <div style={{ textAlign: "center", marginBottom: 32 }}>
          <div style={{ width: 64, height: 64, borderRadius: 18, background: "linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.3))", border: "1px solid rgba(99,102,241,0.5)", display: "flex", alignItems: "center", justifyContent: "center", margin: "0 auto 16px", boxShadow: "0 0 40px rgba(99,102,241,0.25)" }}>
            <Shield size={30} style={{ color: "#a5b4fc" }} />
          </div>
          <h1 style={{ fontSize: 28, fontWeight: 800, color: "white", marginBottom: 4 }}>
            <span className="gradient-text">HireGuard AI</span>
          </h1>
          <p style={{ color: "#475569", fontSize: 13 }}>Enterprise Hiring Governance Platform v2</p>
        </div>
        <div className="glass-bright" style={{ borderRadius: 16, padding: 32 }}>
          <div style={{ display: "flex", gap: 4, marginBottom: 24, padding: 4, background: "rgba(15,23,42,0.8)", borderRadius: 10, border: "1px solid rgba(99,102,241,0.15)" }}>
            {["login", "register"].map(m => (
              <button key={m} onClick={() => setMode(m)} className={`tab-btn ${mode === m ? "active" : ""}`} style={{ flex: 1, textTransform: "capitalize" }}>{m === "login" ? "Sign In" : "Register"}</button>
            ))}
          </div>
          <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
            {mode === "register" && (
              <div>
                <label style={{ fontSize: 12, color: "#64748b", marginBottom: 6, display: "block" }}>Full Name</label>
                <input className="input" value={form.name} onChange={e => setForm(p => ({ ...p, name: e.target.value }))} placeholder="John Smith" style={{ width: "100%", borderRadius: 10, padding: "10px 14px", fontSize: 14 }} />
              </div>
            )}
            <div>
              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 6, display: "block" }}>Email Address</label>
              <div style={{ position: "relative" }}>
                <Mail size={14} style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", color: "#475569" }} />
                <input className="input" value={form.email} onChange={e => setForm(p => ({ ...p, email: e.target.value }))} placeholder="you@company.com" type="email" style={{ width: "100%", borderRadius: 10, padding: "10px 14px 10px 36px", fontSize: 14 }} />
              </div>
            </div>
            <div>
              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 6, display: "block" }}>Password</label>
              <div style={{ position: "relative" }}>
                <Lock size={14} style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", color: "#475569" }} />
                <input className="input" value={form.password} onChange={e => setForm(p => ({ ...p, password: e.target.value }))} placeholder="••••••••" type={showPw ? "text" : "password"} style={{ width: "100%", borderRadius: 10, padding: "10px 40px 10px 36px", fontSize: 14 }} />
                <button onClick={() => setShowPw(!showPw)} style={{ position: "absolute", right: 12, top: "50%", transform: "translateY(-50%)", background: "none", border: "none", cursor: "pointer", color: "#475569" }}>
                  {showPw ? <EyeOff size={14} /> : <Eye size={14} />}
                </button>
              </div>
            </div>
            {mode === "register" && (
              <div>
                <label style={{ fontSize: 12, color: "#64748b", marginBottom: 6, display: "block" }}>Role</label>
                <select className="input" value={form.role} onChange={e => setForm(p => ({ ...p, role: e.target.value }))} style={{ width: "100%", borderRadius: 10, padding: "10px 14px", fontSize: 14 }}>
                  {["Admin", "HR", "Auditor"].map(r => <option key={r} value={r}>{r}</option>)}
                </select>
              </div>
            )}
            {error && <div style={{ padding: "10px 14px", borderRadius: 8, background: "rgba(239,68,68,0.1)", border: "1px solid rgba(239,68,68,0.3)", color: "#fca5a5", fontSize: 13 }}>{error}</div>}
            <button className="btn-primary" onClick={submit} disabled={loading} style={{ width: "100%", padding: "12px", borderRadius: 10, fontSize: 14, justifyContent: "center" }}>
              {loading ? <Spinner size={15} /> : <Shield size={15} />}
              {loading ? "Authenticating..." : mode === "login" ? "Access Platform" : "Create Account"}
            </button>
          </div>
          <p style={{ textAlign: "center", marginTop: 20, fontSize: 12, color: "#334155" }}>Demo: any email / any password</p>
        </div>
      </div>
    </div>
  );
};

// ─── DASHBOARD ────────────────────────────────────────────────────────────────
const Dashboard = ({ user }) => {
  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Executive Dashboard">
        <div style={{ display: "flex", alignItems: "center", gap: 6, padding: "5px 12px", borderRadius: 8, background: "rgba(16,185,129,0.08)", border: "1px solid rgba(16,185,129,0.25)" }}>
          <div className="live-dot" />
          <span style={{ fontSize: 11, color: "#10b981", fontFamily: "JetBrains Mono" }}>LIVE MONITORING</span>
        </div>
      </SectionHeader>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 16, marginBottom: 24 }}>
        <MetricCard icon={Shield} label="Overall Risk Score" value="47" sub="Moderate Risk" color="#f59e0b" trend={-8} />
        <MetricCard icon={AlertTriangle} label="Avg Bias Score" value="38%" sub="Across all interviews" color="#f59e0b" trend={-12} delay={0.05} />
        <MetricCard icon={FileSearch} label="Resume Auth Score" value="73%" sub="Human authenticity" color="#10b981" trend={5} delay={0.1} />
        <MetricCard icon={Activity} label="Compliance Rate" value="87%" sub="EEOC/SHRM alignment" color="#6366f1" trend={3} delay={0.15} />
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 20, marginBottom: 20 }}>
        <div className="card" style={{ padding: 20 }}>
          <div className="section-label">RISK TREND — 8 WEEKS</div>
          <ResponsiveContainer width="100%" height={200}>
            <AreaChart data={MOCK_TREND}>
              <defs>
                {[["bias", "#f59e0b"], ["fraud", "#ef4444"], ["risk", "#6366f1"]].map(([k, c]) => (
                  <linearGradient key={k} id={`g_${k}`} x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor={c} stopOpacity={0.25} />
                    <stop offset="95%" stopColor={c} stopOpacity={0} />
                  </linearGradient>
                ))}
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="rgba(99,102,241,0.07)" />
              <XAxis dataKey="week" stroke="#334155" tick={{ fill: "#64748b", fontSize: 11, fontFamily: "JetBrains Mono" }} />
              <YAxis stroke="#334155" tick={{ fill: "#64748b", fontSize: 11 }} />
              <Tooltip content={<TooltipContent />} />
              <Legend wrapperStyle={{ fontSize: 11, fontFamily: "JetBrains Mono", color: "#64748b" }} />
              <Area type="monotone" dataKey="risk" name="Risk" stroke="#6366f1" fill="url(#g_risk)" strokeWidth={2} />
              <Area type="monotone" dataKey="bias" name="Bias" stroke="#f59e0b" fill="url(#g_bias)" strokeWidth={2} />
              <Area type="monotone" dataKey="fraud" name="AI Fraud" stroke="#ef4444" fill="url(#g_fraud)" strokeWidth={1.5} />
            </AreaChart>
          </ResponsiveContainer>
        </div>
        <div className="card" style={{ padding: 20, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
          <div className="section-label" style={{ alignSelf: "flex-start" }}>OVERALL RISK INDEX</div>
          <ScoreRing score={47} size={130} />
          <div style={{ marginTop: 12 }}>
            <Badge level="moderate" label="Moderate Risk" />
          </div>
          <div style={{ marginTop: 12, display: "grid", gridTemplateColumns: "1fr 1fr", gap: 6, width: "100%" }}>
            {[["Interviews", 124], ["High Risk", 14], ["Resumes", 89], ["Matches", 56]].map(([l, v]) => (
              <div key={l} style={{ padding: 8, borderRadius: 8, background: "rgba(15,23,42,0.5)", border: "1px solid rgba(99,102,241,0.1)", textAlign: "center" }}>
                <div className="metric-value" style={{ fontSize: 18, color: "white" }}>{v}</div>
                <div style={{ fontSize: 10, color: "#475569", fontFamily: "JetBrains Mono" }}>{l}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
        <div className="card" style={{ padding: 20 }}>
          <div className="section-label">DEPARTMENT RISK HEATMAP</div>
          {MOCK_DEPT.map(d => (
            <div key={d.dept} style={{ marginBottom: 10 }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                <span style={{ fontSize: 12, color: "#94a3b8" }}>{d.dept}</span>
                <span style={{ fontSize: 12, fontFamily: "JetBrains Mono", color: riskColor(d.score), fontWeight: 600 }}>{d.score}</span>
              </div>
              <div className="risk-bar">
                <div className="risk-bar-fill" style={{ width: `${d.score}%`, background: riskColor(d.score), boxShadow: `0 0 8px ${riskColor(d.score)}50` }} />
              </div>
            </div>
          ))}
        </div>
        <div className="card" style={{ padding: 20 }}>
          <div className="section-label">RECENT INTERVIEW AUDITS</div>
          {MOCK_INTERVIEWS.map(r => (
            <div key={r._id} style={{ display: "flex", alignItems: "center", gap: 12, padding: "8px 10px", borderRadius: 8, background: "rgba(15,23,42,0.4)", border: "1px solid rgba(99,102,241,0.08)", marginBottom: 6 }}>
              <div style={{ width: 32, height: 32, borderRadius: 8, background: `${riskFromLabel(r.riskLevel)}15`, border: `1px solid ${riskFromLabel(r.riskLevel)}30`, display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 }}>
                <span style={{ fontSize: 12, fontWeight: 700, color: riskFromLabel(r.riskLevel), fontFamily: "JetBrains Mono" }}>{r.biasScore}</span>
              </div>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ fontSize: 13, color: "#e2e8f0", fontWeight: 500, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.recruiterName}</div>
                <div style={{ fontSize: 11, color: "#475569" }}>{r.department} · {r.candidateName}</div>
              </div>
              <Badge level={r.riskLevel.toLowerCase()} label={r.riskLevel} />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// ─── FEATURE 1: INTERVIEW BIAS AUDIT WITH LIVE MONITORING ────────────────────
const InterviewBiasAudit = ({ user, token }) => {
  const [transcript, setTranscript] = useState("");
  const [recruiterName, setRecruiterName] = useState("");
  const [department, setDepartment] = useState("Engineering");
  const [candidateName, setCandidateName] = useState("");
  const [analyzing, setAnalyzing] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState("");
  const [records, setRecords] = useState(MOCK_INTERVIEWS);
  const [search, setSearch] = useState("");
  const [tab, setTab] = useState("analyze");
  const [savingId, setSavingId] = useState(null);
  const [deletingId, setDeletingId] = useState(null);

  // Live Monitoring State
  const [liveMode, setLiveMode] = useState(false);
  const [liveWarning, setLiveWarning] = useState(null);
  const [liveScanning, setLiveScanning] = useState(false);
  const [complianceScore, setComplianceScore] = useState(5);
  const [highlightedSentences, setHighlightedSentences] = useState([]);
  const [lastAnalyzedSentence, setLastAnalyzedSentence] = useState("");
  const [liveAlerts, setLiveAlerts] = useState([]);
  const debounceRef = useRef(null);

  // Explain panel state
  const [explainItem, setExplainItem] = useState(null);

  const callClaude = async (prompt, system) => {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 800, system, messages: [{ role: "user", content: prompt }] })
    });
    const data = await response.json();
    const txt = data.content?.map(b => b.text || "").join("") || "";
    return JSON.parse(txt.replace(/```json\n?|```/g, "").trim());
  };

  // Live monitoring: debounced analysis of last sentence
  const analyzeSentence = useCallback(async (text) => {
    const sentences = text.split(/[.!?\n]+/).map(s => s.trim()).filter(s => s.length > 8);
    if (!sentences.length) return;
    const lastSentence = sentences[sentences.length - 1];
    if (lastSentence === lastAnalyzedSentence || lastSentence.length < 12) return;
    setLastAnalyzedSentence(lastSentence);
    setLiveScanning(true);
    try {
      const result = await callClaude(
        `Analyze this single interview question/statement for bias: "${lastSentence}"`,
        `You are a real-time bias detector. Analyze one sentence for hiring bias.
Respond ONLY with valid JSON: {"bias_detected":true/false,"bias_type":"gender|age|religion|nationality|caste|disability|none","severity":"none|mild|moderate|severe","confidence":0-100,"suggestion":"neutral rephrasing or empty string"}`
      );
      if (result.bias_detected && result.confidence > 45) {
        const warning = { ...result, text: lastSentence, id: Date.now() };
        setLiveWarning(warning);
        setHighlightedSentences(prev => [...prev, lastSentence]);
        const newScore = Math.min(100, complianceScore + (result.severity === "severe" ? 20 : result.severity === "moderate" ? 12 : 6));
        setComplianceScore(newScore);
        setLiveAlerts(prev => [{ ...warning, timestamp: new Date().toLocaleTimeString() }, ...prev.slice(0, 9)]);
      }
    } catch (e) {}
    setLiveScanning(false);
  }, [lastAnalyzedSentence, complianceScore]);

  const handleTranscriptChange = (e) => {
    const val = e.target.value;
    setTranscript(val);
    if (!liveMode) return;
    if (debounceRef.current) clearTimeout(debounceRef.current);
    const lines = val.split("\n");
    const last = lines[lines.length - 1];
    if (last.length > 15 && (last.endsWith("?") || last.endsWith(".") || last.endsWith("!") || last.includes("  "))) {
      debounceRef.current = setTimeout(() => analyzeSentence(val), 800);
    }
  };

  // Highlight biased sentences in transcript display
  const getHighlightedTranscript = () => {
    if (!highlightedSentences.length) return [{ text: transcript, biased: false }];
    let parts = [{ text: transcript, biased: false }];
    highlightedSentences.forEach(sentence => {
      const newParts = [];
      parts.forEach(part => {
        if (part.biased || !part.text.includes(sentence)) { newParts.push(part); return; }
        const idx = part.text.indexOf(sentence);
        if (idx > 0) newParts.push({ text: part.text.slice(0, idx), biased: false });
        newParts.push({ text: sentence, biased: true });
        if (idx + sentence.length < part.text.length) newParts.push({ text: part.text.slice(idx + sentence.length), biased: false });
      });
      parts = newParts;
    });
    return parts;
  };

  const analyze = async () => {
    if (!transcript.trim()) return;
    setAnalyzing(true); setError(""); setResult(null);
    try {
      const data = await callClaude(
        `Analyze this interview transcript:\n\n${transcript}`,
        `You are an expert HR bias detection system. Analyze interview transcripts for discriminatory patterns.
Respond ONLY with valid JSON: {"flaggedPhrases":[{"text":"...","biasType":"gender|age|religion|nationality|caste|disability","severity":"mild|moderate|severe","suggestedRephrase":"...","explanation":"...","triggerKeywords":["..."],"confidence":0-100}],"overallScore":0-100,"complianceIssues":["..."],"recruiterTips":["..."],"summary":"..."}`
      );
      setResult(data);
      if (liveMode) setComplianceScore(data.overallScore || complianceScore);
    } catch (e) { setError("Analysis failed. Check Anthropic API configuration."); }
    setAnalyzing(false);
  };

  const saveAudit = async () => {
    if (!result) return;
    setSavingId("saving");
    await new Promise(r => setTimeout(r, 700));
    const newRec = { _id: Date.now().toString(), recruiterName: recruiterName || user.name, department, candidateName: candidateName || "Anonymous", biasScore: result.overallScore, riskLevel: result.overallScore < 25 ? "Low" : result.overallScore < 50 ? "Moderate" : result.overallScore < 75 ? "High" : "Critical", status: "Pending", createdAt: new Date().toISOString() };
    setRecords(p => [newRec, ...p]);
    setSavingId(null);
    setTab("records");
  };

  const deleteRecord = (id) => {
    setDeletingId(id);
    setTimeout(() => { setRecords(p => p.filter(r => r._id !== id)); setDeletingId(null); }, 400);
  };

  const exportCSV = () => {
    const csv = "Date,Recruiter,Department,Candidate,Bias Score,Risk Level,Status\n" + records.map(r => `${r.createdAt.split("T")[0]},"${r.recruiterName}","${r.department}","${r.candidateName}",${r.biasScore},${r.riskLevel},${r.status}`).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "bias-audits.csv"; a.click();
  };

  const filtered = records.filter(r => !search || r.recruiterName.toLowerCase().includes(search.toLowerCase()) || r.candidateName?.toLowerCase().includes(search.toLowerCase()));

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Interview Bias Audit">
        <div style={{ display: "flex", gap: 8 }}>
          {["analyze", "records"].map(t => (
            <button key={t} className={`tab-btn ${tab === t ? "active" : ""}`} onClick={() => setTab(t)}>
              {t === "analyze" ? "🔍 Analyze" : `📋 Records (${records.length})`}
            </button>
          ))}
        </div>
      </SectionHeader>

      {tab === "analyze" ? (
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1.3fr", gap: 20 }}>
          {/* INPUT PANEL */}
          <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
            {/* ═══ LIVE MODE TOGGLE ═══ */}
            <div className={`card ${liveMode ? "card-live" : ""}`} style={{ padding: 16, transition: "all 0.3s" }}>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: liveMode ? 14 : 0 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ width: 34, height: 34, borderRadius: 9, background: liveMode ? "rgba(99,102,241,0.2)" : "rgba(30,41,59,0.8)", border: `1px solid ${liveMode ? "rgba(99,102,241,0.5)" : "rgba(99,102,241,0.15)"}`, display: "flex", alignItems: "center", justifyContent: "center", transition: "all 0.3s" }}>
                    <Radio size={15} style={{ color: liveMode ? "#a5b4fc" : "#475569" }} />
                  </div>
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 600, color: liveMode ? "#e2e8f0" : "#94a3b8" }}>Live Interview Monitoring Mode</div>
                    <div style={{ fontSize: 11, color: "#475569" }}>Real-time bias detection as you type</div>
                  </div>
                </div>
                <button
                  onClick={() => { setLiveMode(!liveMode); if (!liveMode) { setLiveWarning(null); setLiveAlerts([]); setComplianceScore(5); setHighlightedSentences([]); } }}
                  className={`toggle-track ${liveMode ? "toggle-live" : "toggle-off"}`}>
                  <div className="toggle-thumb" style={{ left: liveMode ? "calc(100% - 23px)" : "3px" }} />
                </button>
              </div>

              {liveMode && (
                <div className="scale-in" style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                  {/* AI Monitoring indicator */}
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "8px 12px", borderRadius: 8, background: "rgba(99,102,241,0.08)", border: "1px solid rgba(99,102,241,0.2)" }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      {liveScanning ? (
                        <><Spinner size={10} /><span style={{ fontSize: 11, color: "#a5b4fc", fontFamily: "JetBrains Mono" }}>Scanning sentence...</span></>
                      ) : (
                        <><div className="live-dot" /><span style={{ fontSize: 11, color: "#10b981", fontFamily: "JetBrains Mono" }}>AI Monitoring Active</span></>
                      )}
                    </div>
                    <span style={{ fontSize: 11, color: "#475569", fontFamily: "JetBrains Mono" }}>{liveAlerts.length} alerts</span>
                  </div>
                  {/* Compliance meter mini */}
                  <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                    <ComplianceMeter score={complianceScore} />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 11, color: "#64748b", fontFamily: "JetBrains Mono", marginBottom: 6 }}>LIVE COMPLIANCE RISK</div>
                      {[["Gender Bias", liveAlerts.filter(a => a.bias_type === "gender").length * 18],
                        ["Age Discrimination", liveAlerts.filter(a => a.bias_type === "age").length * 20],
                        ["Religious Inquiry", liveAlerts.filter(a => a.bias_type === "religion").length * 22],
                        ["Nationality Bias", liveAlerts.filter(a => a.bias_type === "nationality").length * 15]
                      ].map(([l, v]) => (
                        <div key={l} style={{ marginBottom: 5 }}>
                          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 2 }}>
                            <span style={{ fontSize: 10, color: "#475569" }}>{l}</span>
                            <span style={{ fontSize: 10, color: riskColor(v), fontFamily: "JetBrains Mono" }}>{v}</span>
                          </div>
                          <div className="risk-bar" style={{ height: 4 }}>
                            <div className="risk-bar-fill" style={{ width: `${Math.min(v, 100)}%`, background: riskColor(v) }} />
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  {/* Recent live alerts */}
                  {liveAlerts.length > 0 && (
                    <div style={{ maxHeight: 100, overflowY: "auto" }}>
                      {liveAlerts.slice(0, 3).map((a, i) => (
                        <div key={i} style={{ display: "flex", gap: 8, padding: "5px 0", borderBottom: "1px solid rgba(239,68,68,0.07)", alignItems: "center" }}>
                          <div className="warn-dot" style={{ width: 6, height: 6, flexShrink: 0 }} />
                          <span style={{ fontSize: 11, color: "#fca5a5", flex: 1, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{a.bias_type} bias · {a.severity}</span>
                          <span style={{ fontSize: 10, color: "#334155", fontFamily: "JetBrains Mono" }}>{a.timestamp}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Input Form */}
            <div className="card" style={{ padding: 18 }}>
              <div className="section-label">INTERVIEW DETAILS</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginBottom: 12 }}>
                <div>
                  <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Recruiter Name</label>
                  <input className="input" value={recruiterName} onChange={e => setRecruiterName(e.target.value)} placeholder={user.name} style={{ width: "100%", borderRadius: 8, padding: "8px 10px", fontSize: 13 }} />
                </div>
                <div>
                  <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Department</label>
                  <select className="input" value={department} onChange={e => setDepartment(e.target.value)} style={{ width: "100%", borderRadius: 8, padding: "8px 10px", fontSize: 13 }}>
                    {["Engineering", "Sales", "HR", "Design", "Operations", "Legal", "Marketing", "Finance"].map(d => <option key={d}>{d}</option>)}
                  </select>
                </div>
                <div style={{ gridColumn: "1/-1" }}>
                  <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Candidate Name</label>
                  <input className="input" value={candidateName} onChange={e => setCandidateName(e.target.value)} placeholder="Anonymous" style={{ width: "100%", borderRadius: 8, padding: "8px 10px", fontSize: 13 }} />
                </div>
              </div>

              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 6, display: "block" }}>
                Interview Transcript
                {liveMode && <span style={{ marginLeft: 8, fontSize: 10, color: "#6366f1", fontFamily: "JetBrains Mono", fontWeight: 600 }}>● LIVE ANALYSIS ACTIVE</span>}
              </label>

              {/* Transcript with highlighting */}
              <div style={{ position: "relative" }}>
                {liveMode && transcript ? (
                  <div style={{ position: "relative" }}>
                    <textarea
                      className={`input ${liveMode ? "input-live" : ""}`}
                      value={transcript}
                      onChange={handleTranscriptChange}
                      placeholder="Type interview transcript... bias detected in real-time"
                      style={{ width: "100%", borderRadius: 10, padding: "10px 12px", fontSize: 13, minHeight: 160, fontFamily: "'JetBrains Mono', monospace", lineHeight: 1.6 }}
                    />
                    <div className="scan-overlay">
                      {liveScanning && <div className="scan-line" />}
                    </div>
                  </div>
                ) : (
                  <textarea
                    className="input"
                    value={transcript}
                    onChange={handleTranscriptChange}
                    placeholder={liveMode ? "Type interview transcript... bias is detected in real-time as you type" : "Paste interview transcript here..."}
                    style={{ width: "100%", borderRadius: 10, padding: "10px 12px", fontSize: 13, minHeight: 160, fontFamily: liveMode ? "'JetBrains Mono', monospace" : "inherit", lineHeight: 1.6 }}
                  />
                )}
              </div>

              <div style={{ display: "flex", gap: 8, marginTop: 10 }}>
                <button className="btn-secondary" onClick={() => setTranscript(DEMO_TRANSCRIPT)} style={{ padding: "8px 12px", borderRadius: 8, fontSize: 13 }}>
                  <Zap size={13} /> Load Demo
                </button>
                <button className="btn-primary" onClick={analyze} disabled={analyzing || !transcript.trim()} style={{ flex: 1, padding: "10px", borderRadius: 8, fontSize: 13, justifyContent: "center" }}>
                  {analyzing ? <><Spinner size={14} /> Analyzing...</> : <><Brain size={14} /> Analyze Transcript</>}
                </button>
              </div>
              {error && <div style={{ marginTop: 10, padding: "8px 12px", borderRadius: 8, background: "rgba(239,68,68,0.1)", color: "#fca5a5", fontSize: 12 }}>{error}</div>}
            </div>
          </div>

          {/* RESULTS PANEL */}
          <div style={{ position: "relative", display: "flex", flexDirection: "column", gap: 14 }}>
            {/* Live bias warning popup */}
            <BiasWarningPopup
              warning={liveWarning}
              onDismiss={() => setLiveWarning(null)}
              onExplain={(item) => { setExplainItem({ ...item, biasType: item.bias_type }); setLiveWarning(null); }}
            />

            {!result && !analyzing && (
              <div className="card" style={{ padding: 40, textAlign: "center", display: "flex", flexDirection: "column", alignItems: "center", gap: 12 }}>
                <Brain size={40} style={{ color: "#334155" }} />
                <p style={{ color: "#475569" }}>Analyze a transcript to see detailed results</p>
                {liveMode && <p style={{ color: "#6366f1", fontSize: 12 }}>Live monitoring active — alerts appear as you type</p>}
              </div>
            )}
            {analyzing && (
              <div className="card" style={{ padding: 40, textAlign: "center" }}>
                <div className="float" style={{ marginBottom: 16 }}><Brain size={40} style={{ color: "#6366f1" }} /></div>
                <p style={{ color: "#a5b4fc" }}>Deep analyzing transcript...</p>
              </div>
            )}
            {result && (
              <div className="scale-in" style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                {/* Score Header */}
                <div className="card" style={{ padding: 18, display: "flex", gap: 20, alignItems: "center" }}>
                  <ScoreRing score={result.overallScore} size={88} />
                  <div style={{ flex: 1 }}>
                    <div style={{ fontSize: 13, color: "#64748b", marginBottom: 4 }}>ANALYSIS COMPLETE</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: riskColor(result.overallScore), marginBottom: 6 }}>{riskLabel(result.overallScore)}</div>
                    <div style={{ fontSize: 12, color: "#64748b", marginBottom: 8 }}>{result.flaggedPhrases?.length || 0} issues · {result.complianceIssues?.length || 0} compliance risks</div>
                    <button className="btn-success" onClick={saveAudit} disabled={!!savingId} style={{ padding: "6px 12px", borderRadius: 7, fontSize: 12 }}>
                      {savingId ? <Spinner size={12} /> : <Save size={12} />} Save Audit
                    </button>
                  </div>
                </div>

                {/* Summary */}
                <div className="card" style={{ padding: 14 }}>
                  <div className="section-label">AI SUMMARY</div>
                  <p style={{ fontSize: 13, color: "#94a3b8", lineHeight: 1.6 }}>{result.summary}</p>
                </div>

                {/* Flagged Phrases with Explain buttons */}
                {result.flaggedPhrases?.length > 0 && (
                  <div className="card" style={{ padding: 14 }}>
                    <div className="section-label">FLAGGED PHRASES ({result.flaggedPhrases.length})</div>
                    <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
                      {result.flaggedPhrases.map((p, i) => (
                        <div key={i} style={{ padding: 12, borderRadius: 8, background: "rgba(239,68,68,0.05)", border: "1px solid rgba(239,68,68,0.18)" }}>
                          <div style={{ display: "flex", gap: 8, alignItems: "flex-start", marginBottom: 8, flexWrap: "wrap" }}>
                            <AlertTriangle size={13} style={{ color: "#ef4444", marginTop: 2, flexShrink: 0 }} />
                            <span style={{ fontSize: 12, color: "#fca5a5", fontStyle: "italic", flex: 1 }}>"{p.text}"</span>
                            <div style={{ display: "flex", gap: 4, flexShrink: 0, flexWrap: "wrap" }}>
                              <Badge level={p.biasType} label={p.biasType} />
                              <Badge level={p.severity} label={p.severity} />
                              {p.confidence && <span style={{ fontSize: 10, color: "#6366f1", fontFamily: "JetBrains Mono", background: "rgba(99,102,241,0.15)", padding: "2px 6px", borderRadius: 4 }}>{p.confidence}%</span>}
                            </div>
                          </div>
                          <div style={{ display: "flex", gap: 8, alignItems: "flex-start", padding: "7px 10px", borderRadius: 6, background: "rgba(16,185,129,0.06)", border: "1px solid rgba(16,185,129,0.15)", marginBottom: 8 }}>
                            <CheckCircle size={12} style={{ color: "#10b981", marginTop: 1, flexShrink: 0 }} />
                            <span style={{ fontSize: 12, color: "#6ee7b7" }}>{p.suggestedRephrase}</span>
                          </div>
                          {/* EXPLAIN BUTTON */}
                          <button className="btn-explain" onClick={() => setExplainItem(p)}>
                            <Microscope size={11} /> Why was this flagged?
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Compliance + Tips */}
                {result.complianceIssues?.length > 0 && (
                  <div className="card" style={{ padding: 14 }}>
                    <div className="section-label">EEOC/SHRM VIOLATIONS</div>
                    {result.complianceIssues.map((c, i) => (
                      <div key={i} style={{ display: "flex", gap: 8, padding: "5px 0", borderBottom: "1px solid rgba(239,68,68,0.07)" }}>
                        <XCircle size={12} style={{ color: "#ef4444", flexShrink: 0, marginTop: 2 }} />
                        <span style={{ fontSize: 12, color: "#fca5a5" }}>{c}</span>
                      </div>
                    ))}
                  </div>
                )}
                {result.recruiterTips?.length > 0 && (
                  <div className="card" style={{ padding: 14 }}>
                    <div className="section-label">COACHING RECOMMENDATIONS</div>
                    {result.recruiterTips.map((t, i) => (
                      <div key={i} style={{ display: "flex", gap: 8, padding: "5px 0" }}>
                        <Zap size={12} style={{ color: "#6366f1", flexShrink: 0, marginTop: 2 }} />
                        <span style={{ fontSize: 12, color: "#a5b4fc" }}>{t}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      ) : (
        <div>
          <div style={{ display: "flex", gap: 12, marginBottom: 16 }}>
            <div style={{ position: "relative", flex: 1 }}>
              <Search size={14} style={{ position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)", color: "#475569" }} />
              <input className="input" value={search} onChange={e => setSearch(e.target.value)} placeholder="Search recruiters or candidates..." style={{ width: "100%", borderRadius: 8, padding: "8px 12px 8px 34px", fontSize: 13 }} />
            </div>
            <button className="btn-secondary" onClick={exportCSV} style={{ padding: "8px 14px", borderRadius: 8, fontSize: 13 }}>
              <Download size={13} /> Export CSV
            </button>
          </div>
          <div className="card" style={{ overflow: "hidden" }}>
            <table className="table">
              <thead>
                <tr><th>Date</th><th>Recruiter</th><th>Dept</th><th>Candidate</th><th>Bias Score</th><th>Risk</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                {filtered.map(r => (
                  <tr key={r._id}>
                    <td style={{ fontFamily: "JetBrains Mono", fontSize: 11 }}>{new Date(r.createdAt).toLocaleDateString()}</td>
                    <td style={{ fontWeight: 500, color: "#e2e8f0" }}>{r.recruiterName}</td>
                    <td>{r.department}</td>
                    <td>{r.candidateName}</td>
                    <td><span style={{ fontFamily: "JetBrains Mono", fontWeight: 700, color: riskFromLabel(r.riskLevel) }}>{r.biasScore}</span></td>
                    <td><Badge level={r.riskLevel.toLowerCase()} label={r.riskLevel} /></td>
                    <td><Badge level={r.status.toLowerCase()} label={r.status} /></td>
                    <td>
                      <button className="btn-danger" onClick={() => deleteRecord(r._id)} disabled={deletingId === r._id} style={{ padding: "5px 9px", borderRadius: 6, fontSize: 12 }}>
                        {deletingId === r._id ? <Spinner size={12} /> : <Trash2 size={12} />}
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* EXPLAIN PANEL */}
      {explainItem && (
        <ExplainPanel item={explainItem} type="bias" onClose={() => setExplainItem(null)} />
      )}
    </div>
  );
};

// ─── RESUME INTELLIGENCE WITH XAI ────────────────────────────────────────────
const ResumeIntelligence = ({ user, token }) => {
  const [resumeText, setResumeText] = useState("");
  const [candidateName, setCandidateName] = useState("");
  const [position, setPosition] = useState("");
  const [dragging, setDragging] = useState(false);
  const [filename, setFilename] = useState("");
  const [analyzing, setAnalyzing] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState("");
  const [records, setRecords] = useState(MOCK_RESUMES);
  const [tab, setTab] = useState("analyze");
  const [deletingId, setDeletingId] = useState(null);
  const [explainItem, setExplainItem] = useState(null);
  const fileRef = useRef();

  const callClaude = async (text) => {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: `You are an AI content detection expert. Detect AI-generated content signals in resumes.
Respond ONLY with valid JSON: {"aiProbabilityScore":0-100,"classification":"Likely Human|Mixed|Likely AI-Generated|Almost Certainly AI","sectionScores":{"summary":0-100,"experience":0-100,"skills":0-100,"education":0-100},"highlightedPhrases":[{"text":"...","reason":"...","confidence":0-100}],"humanizationTips":["..."],"plagiarismFlags":["..."],"voiceFingerprint":{"formal":0-100,"casual":0-100,"technical":0-100,"creative":0-100}}`,
        messages: [{ role: "user", content: `Analyze this resume:\n\n${text}` }]
      })
    });
    const data = await response.json();
    const t = data.content?.map(b => b.text || "").join("") || "";
    return JSON.parse(t.replace(/```json\n?|```/g, "").trim());
  };

  const analyze = async () => {
    if (!resumeText.trim()) return;
    setAnalyzing(true); setError(""); setResult(null);
    try {
      const data = await callClaude(resumeText);
      setResult(data);
      setRecords(p => [{ _id: Date.now().toString(), candidateName: candidateName || "Unknown", position: position || "Unspecified", aiProbabilityScore: data.aiProbabilityScore, classification: data.classification, status: "Pending", createdAt: new Date().toISOString() }, ...p]);
    } catch (e) { setError("Analysis failed."); }
    setAnalyzing(false);
  };

  const handleFile = (file) => {
    if (!file) return;
    if (file.type !== "application/pdf") { setError("PDF only"); return; }
    setFilename(file.name);
    setResumeText(DEMO_RESUME);
  };

  const deleteRecord = (id) => { setDeletingId(id); setTimeout(() => { setRecords(p => p.filter(r => r._id !== id)); setDeletingId(null); }, 400); };
  const classColor = (cls) => ({ "Likely Human": "#10b981", "Mixed": "#f59e0b", "Likely AI-Generated": "#ef4444", "Almost Certainly AI": "#dc2626" }[cls] || "#94a3b8");

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Resume Intelligence">
        <div style={{ display: "flex", gap: 8 }}>
          {["analyze", "records"].map(t => (
            <button key={t} className={`tab-btn ${tab === t ? "active" : ""}`} onClick={() => setTab(t)}>
              {t === "analyze" ? "🔍 Analyze" : `📋 Records (${records.length})`}
            </button>
          ))}
        </div>
      </SectionHeader>
      {tab === "analyze" ? (
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1.2fr", gap: 20 }}>
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">CANDIDATE & UPLOAD</div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginBottom: 12 }}>
              <div>
                <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Candidate Name</label>
                <input className="input" value={candidateName} onChange={e => setCandidateName(e.target.value)} placeholder="Full name" style={{ width: "100%", borderRadius: 8, padding: "8px 10px", fontSize: 13 }} />
              </div>
              <div>
                <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Position</label>
                <input className="input" value={position} onChange={e => setPosition(e.target.value)} placeholder="Job title" style={{ width: "100%", borderRadius: 8, padding: "8px 10px", fontSize: 13 }} />
              </div>
            </div>
            <div className={`drag-zone ${dragging ? "dragging" : ""}`} onDragOver={e => { e.preventDefault(); setDragging(true); }} onDragLeave={() => setDragging(false)} onDrop={e => { e.preventDefault(); setDragging(false); handleFile(e.dataTransfer.files[0]); }} onClick={() => fileRef.current?.click()} style={{ marginBottom: 12 }}>
              <input ref={fileRef} type="file" accept=".pdf" style={{ display: "none" }} onChange={e => handleFile(e.target.files[0])} />
              <Upload size={24} style={{ color: filename ? "#10b981" : "#475569", margin: "0 auto 8px" }} />
              <p style={{ fontSize: 13, color: filename ? "#10b981" : "#64748b" }}>{filename || "Drop PDF or click to browse"}</p>
              <p style={{ fontSize: 11, color: "#334155", marginTop: 4 }}>PDF only · Max 10MB</p>
            </div>
            <textarea className="input" value={resumeText} onChange={e => setResumeText(e.target.value)} placeholder="Or paste resume text..." style={{ width: "100%", borderRadius: 8, padding: "10px 12px", fontSize: 12, minHeight: 130 }} />
            <div style={{ display: "flex", gap: 8, marginTop: 10 }}>
              <button className="btn-secondary" onClick={() => { setResumeText(DEMO_RESUME); setFilename(""); }} style={{ padding: "8px 12px", borderRadius: 8, fontSize: 13 }}>
                <Zap size={13} /> Demo
              </button>
              <button className="btn-primary" onClick={analyze} disabled={analyzing || !resumeText.trim()} style={{ flex: 1, padding: "10px", borderRadius: 8, fontSize: 13, justifyContent: "center" }}>
                {analyzing ? <><Spinner size={14} /> Scanning...</> : <><FileSearch size={14} /> Detect AI Content</>}
              </button>
            </div>
            {error && <div style={{ marginTop: 10, padding: "8px 12px", borderRadius: 8, background: "rgba(239,68,68,0.1)", color: "#fca5a5", fontSize: 12 }}>{error}</div>}
          </div>

          <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
            {!result && !analyzing && (
              <div className="card" style={{ padding: 40, textAlign: "center", display: "flex", flexDirection: "column", alignItems: "center", gap: 12 }}>
                <FileSearch size={40} style={{ color: "#334155" }} /><p style={{ color: "#475569" }}>Upload or paste a resume to analyze</p>
              </div>
            )}
            {analyzing && (
              <div className="card" style={{ padding: 40, textAlign: "center" }}>
                <div className="float" style={{ marginBottom: 16 }}><Cpu size={40} style={{ color: "#6366f1" }} /></div>
                <p style={{ color: "#a5b4fc" }}>Scanning for AI patterns...</p>
              </div>
            )}
            {result && (
              <div className="scale-in" style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                <div className="card" style={{ padding: 18 }}>
                  <div style={{ display: "flex", gap: 16, alignItems: "center" }}>
                    <div style={{ textAlign: "center" }}>
                      <div style={{ fontSize: 44, fontWeight: 800, color: classColor(result.classification), fontFamily: "JetBrains Mono", lineHeight: 1 }}>{result.aiProbabilityScore}%</div>
                      <div style={{ fontSize: 10, color: "#64748b", fontFamily: "JetBrains Mono" }}>AI PROBABILITY</div>
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 16, fontWeight: 700, color: classColor(result.classification), marginBottom: 6 }}>{result.classification}</div>
                      <div style={{ height: 6, borderRadius: 3, background: "rgba(30,41,59,0.8)", marginBottom: 10 }}>
                        <div style={{ height: "100%", borderRadius: 3, width: `${result.aiProbabilityScore}%`, background: `linear-gradient(90deg, #10b981, ${classColor(result.classification)})`, transition: "width 1.5s ease" }} />
                      </div>
                      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 5 }}>
                        {Object.entries(result.sectionScores || {}).map(([k, v]) => (
                          <div key={k} style={{ padding: "5px 9px", borderRadius: 6, background: "rgba(15,23,42,0.5)", border: "1px solid rgba(99,102,241,0.1)", display: "flex", justifyContent: "space-between" }}>
                            <span style={{ fontSize: 11, color: "#64748b", textTransform: "capitalize" }}>{k}</span>
                            <span style={{ fontSize: 11, fontWeight: 700, color: riskColor(v), fontFamily: "JetBrains Mono" }}>{v}%</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>

                {/* AI Phrases with explain buttons */}
                {result.highlightedPhrases?.length > 0 && (
                  <div className="card" style={{ padding: 14 }}>
                    <div className="section-label">AI-INDICATIVE PHRASES</div>
                    {result.highlightedPhrases.slice(0, 5).map((p, i) => (
                      <div key={i} style={{ padding: "8px 0", borderBottom: "1px solid rgba(99,102,241,0.06)" }}>
                        <div style={{ display: "flex", gap: 8, alignItems: "flex-start", marginBottom: 4 }}>
                          <AlertTriangle size={12} style={{ color: "#f59e0b", flexShrink: 0, marginTop: 2 }} />
                          <div style={{ flex: 1 }}>
                            <div style={{ fontSize: 12, color: "#fbbf24", marginBottom: 2 }}>"{p.text}"</div>
                            <div style={{ fontSize: 11, color: "#64748b" }}>{p.reason}</div>
                          </div>
                          {p.confidence && <span style={{ fontSize: 10, color: "#6366f1", fontFamily: "JetBrains Mono", background: "rgba(99,102,241,0.15)", padding: "2px 5px", borderRadius: 4, flexShrink: 0 }}>{p.confidence}%</span>}
                        </div>
                        <button className="btn-explain" onClick={() => setExplainItem({ ...p, biasType: "ai-content", severity: "moderate", flag: p.text })}>
                          <Microscope size={11} /> Why was this flagged?
                        </button>
                      </div>
                    ))}
                  </div>
                )}

                {result.humanizationTips?.length > 0 && (
                  <div className="card" style={{ padding: 14 }}>
                    <div className="section-label">HUMANIZATION TIPS</div>
                    {result.humanizationTips.map((t, i) => (
                      <div key={i} style={{ display: "flex", gap: 8, padding: "5px 0" }}>
                        <CheckCircle size={12} style={{ color: "#10b981", flexShrink: 0, marginTop: 2 }} />
                        <span style={{ fontSize: 12, color: "#6ee7b7" }}>{t}</span>
                      </div>
                    ))}
                  </div>
                )}

                {result.voiceFingerprint && (
                  <div className="card" style={{ padding: 14 }}>
                    <div className="section-label">VOICE FINGERPRINT</div>
                    <ResponsiveContainer width="100%" height={150}>
                      <RadarChart data={Object.entries(result.voiceFingerprint).map(([k, v]) => ({ trait: k.charAt(0).toUpperCase() + k.slice(1), value: v }))}>
                        <PolarGrid stroke="rgba(99,102,241,0.15)" />
                        <PolarAngleAxis dataKey="trait" tick={{ fill: "#64748b", fontSize: 10, fontFamily: "JetBrains Mono" }} />
                        <Radar dataKey="value" stroke="#6366f1" fill="#6366f1" fillOpacity={0.2} strokeWidth={2} />
                      </RadarChart>
                    </ResponsiveContainer>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      ) : (
        <div className="card" style={{ overflow: "hidden" }}>
          <table className="table">
            <thead><tr><th>Date</th><th>Candidate</th><th>Position</th><th>AI Score</th><th>Classification</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
              {records.map(r => (
                <tr key={r._id}>
                  <td style={{ fontFamily: "JetBrains Mono", fontSize: 11 }}>{new Date(r.createdAt).toLocaleDateString()}</td>
                  <td style={{ fontWeight: 500, color: "#e2e8f0" }}>{r.candidateName}</td>
                  <td>{r.position}</td>
                  <td><span style={{ fontFamily: "JetBrains Mono", fontWeight: 700, color: classColor(r.classification) }}>{r.aiProbabilityScore}%</span></td>
                  <td style={{ color: classColor(r.classification), fontSize: 12 }}>{r.classification}</td>
                  <td><Badge level={r.status.toLowerCase()} label={r.status} /></td>
                  <td><button className="btn-danger" onClick={() => deleteRecord(r._id)} disabled={deletingId === r._id} style={{ padding: "5px 8px", borderRadius: 6, fontSize: 12 }}>{deletingId === r._id ? <Spinner size={12} /> : <Trash2 size={12} />}</button></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
      {explainItem && <ExplainPanel item={explainItem} type="ai-resume" onClose={() => setExplainItem(null)} />}
    </div>
  );
};

// ─── SKILL MATCH ENGINE ───────────────────────────────────────────────────────
const SkillMatchEngine = ({ user }) => {
  const [jobDesc, setJobDesc] = useState("");
  const [resumeText, setResumeText] = useState("");
  const [candidateName, setCandidateName] = useState("");
  const [position, setPosition] = useState("");
  const [analyzing, setAnalyzing] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState("");

  const callClaude = async (jd, rt) => {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514", max_tokens: 800,
        system: `You are a skill matching expert. Compare job requirements to resume. Respond ONLY with valid JSON: {"matchScore":0-100,"classification":"Excellent Fit|Strong Fit|Moderate Fit|Weak Fit|Poor Fit","matchedSkills":["..."],"missingSkills":["..."],"suggestedQuestions":["..."],"fitSummary":"..."}`,
        messages: [{ role: "user", content: `JD:\n${jd}\n\nResume:\n${rt}` }]
      })
    });
    const data = await response.json();
    const t = data.content?.map(b => b.text || "").join("") || "";
    return JSON.parse(t.replace(/```json\n?|```/g, "").trim());
  };

  const analyze = async () => {
    if (!jobDesc.trim() || !resumeText.trim()) return;
    setAnalyzing(true); setError(""); setResult(null);
    try { setResult(await callClaude(jobDesc, resumeText)); } catch (e) { setError("Match failed."); }
    setAnalyzing(false);
  };

  const classColor = (cls) => ({ "Excellent Fit": "#10b981", "Strong Fit": "#34d399", "Moderate Fit": "#f59e0b", "Weak Fit": "#ef4444", "Poor Fit": "#dc2626" }[cls] || "#94a3b8");

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Skill Match Engine" />
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20, marginBottom: 20 }}>
        <div className="card" style={{ padding: 20 }}>
          <div className="section-label">JOB DESCRIPTION</div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginBottom: 10 }}>
            <div>
              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Candidate</label>
              <input className="input" value={candidateName} onChange={e => setCandidateName(e.target.value)} placeholder="Name" style={{ width: "100%", borderRadius: 8, padding: "7px 10px", fontSize: 13 }} />
            </div>
            <div>
              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Position</label>
              <input className="input" value={position} onChange={e => setPosition(e.target.value)} placeholder="Job title" style={{ width: "100%", borderRadius: 8, padding: "7px 10px", fontSize: 13 }} />
            </div>
          </div>
          <textarea className="input" value={jobDesc} onChange={e => setJobDesc(e.target.value)} placeholder="Paste job description..." style={{ width: "100%", borderRadius: 8, padding: "10px", fontSize: 13, minHeight: 130 }} />
          <button className="btn-secondary" style={{ marginTop: 8, padding: "6px 12px", borderRadius: 7, fontSize: 12 }} onClick={() => setJobDesc("Senior Software Engineer with 5+ years of React, Node.js, TypeScript. AWS, Docker, Kubernetes. Strong problem solving. Bachelor's in CS.")}>
            <Zap size={12} /> Demo JD
          </button>
        </div>
        <div className="card" style={{ padding: 20 }}>
          <div className="section-label">CANDIDATE RESUME</div>
          <textarea className="input" value={resumeText} onChange={e => setResumeText(e.target.value)} placeholder="Paste candidate resume..." style={{ width: "100%", borderRadius: 8, padding: "10px", fontSize: 13, minHeight: 155 }} />
          <div style={{ display: "flex", gap: 8, marginTop: 8 }}>
            <button className="btn-secondary" style={{ padding: "6px 12px", borderRadius: 7, fontSize: 12 }} onClick={() => setResumeText(DEMO_RESUME)}><Zap size={12} /> Demo</button>
            <button className="btn-primary" onClick={analyze} disabled={analyzing || !jobDesc.trim() || !resumeText.trim()} style={{ flex: 1, padding: "8px", borderRadius: 8, fontSize: 13, justifyContent: "center" }}>
              {analyzing ? <><Spinner size={14} /> Matching...</> : <><Target size={14} /> Run Match</>}
            </button>
          </div>
          {error && <div style={{ marginTop: 8, padding: "8px 10px", borderRadius: 7, background: "rgba(239,68,68,0.1)", color: "#fca5a5", fontSize: 12 }}>{error}</div>}
        </div>
      </div>
      {result && (
        <div className="scale-in" style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 16 }}>
          <div className="card" style={{ padding: 20, textAlign: "center" }}>
            <ScoreRing score={result.matchScore} size={100} />
            <div style={{ marginTop: 12, fontSize: 15, fontWeight: 700, color: classColor(result.classification) }}>{result.classification}</div>
            <p style={{ fontSize: 12, color: "#64748b", marginTop: 8 }}>{result.fitSummary}</p>
          </div>
          <div className="card" style={{ padding: 14 }}>
            <div className="section-label">MATCHED ✓ / MISSING ✗</div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5, marginBottom: 10 }}>
              {result.matchedSkills?.map((s, i) => <span key={i} style={{ padding: "2px 8px", borderRadius: 5, background: "rgba(16,185,129,0.1)", border: "1px solid rgba(16,185,129,0.25)", color: "#10b981", fontSize: 11 }}>{s}</span>)}
            </div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
              {result.missingSkills?.map((s, i) => <span key={i} style={{ padding: "2px 8px", borderRadius: 5, background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.2)", color: "#fca5a5", fontSize: 11 }}>{s}</span>)}
            </div>
          </div>
          <div className="card" style={{ padding: 14 }}>
            <div className="section-label">SUGGESTED QUESTIONS</div>
            {result.suggestedQuestions?.map((q, i) => (
              <div key={i} style={{ display: "flex", gap: 8, padding: "5px 0", borderBottom: "1px solid rgba(99,102,241,0.07)" }}>
                <Zap size={12} style={{ color: "#6366f1", flexShrink: 0, marginTop: 2 }} />
                <span style={{ fontSize: 12, color: "#a5b4fc" }}>{q}</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// ─── FEATURE 3: RECRUITER RISK HEATMAP & ANALYTICS ───────────────────────────
const RecruiterAnalytics = ({ user }) => {
  const [selectedRecruiter, setSelectedRecruiter] = useState(MOCK_RECRUITERS[0]);
  const [view, setView] = useState("heatmap");

  const getTrend = (sessions) => {
    if (sessions.length < 3) return "stable";
    const recent = sessions.slice(-3).reduce((a, s) => a + s.score, 0) / 3;
    const older = sessions.slice(0, 3).reduce((a, s) => a + s.score, 0) / 3;
    if (recent < older - 5) return "improving";
    if (recent > older + 5) return "worsening";
    return "stable";
  };

  const trendIcon = (t) => t === "improving" ? <ChevronDown size={13} /> : t === "worsening" ? <ChevronUp size={13} /> : <ArrowRight size={13} />;
  const trendLabel = (t) => t === "improving" ? "Improving" : t === "worsening" ? "Worsening" : "Stable";

  const sortedRecruiters = [...MOCK_RECRUITERS].sort((a, b) => a.avgBias - b.avgBias);

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Recruiter Analytics">
        <div style={{ display: "flex", gap: 6 }}>
          {[["heatmap", "🟥 Heatmap"], ["trends", "📈 Trends"], ["leaderboard", "🏆 Leaderboard"]].map(([v, l]) => (
            <button key={v} className={`tab-btn ${view === v ? "active" : ""}`} onClick={() => setView(v)}>{l}</button>
          ))}
        </div>
      </SectionHeader>

      {/* ── A) RECRUITER RISK HEATMAP ── */}
      {view === "heatmap" && (
        <div className="scale-in" style={{ display: "flex", flexDirection: "column", gap: 20 }}>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 14, marginBottom: 4 }}>
            <MetricCard icon={UserCheck} label="Total Recruiters" value={MOCK_RECRUITERS.length} color="#6366f1" />
            <MetricCard icon={AlertTriangle} label="High Risk Recruiters" value={MOCK_RECRUITERS.filter(r => r.avgBias >= 50).length} color="#ef4444" delay={0.05} />
            <MetricCard icon={Activity} label="Platform Avg Bias" value={`${Math.round(MOCK_RECRUITERS.reduce((a,r) => a + r.avgBias, 0) / MOCK_RECRUITERS.length)}`} color="#f59e0b" delay={0.1} />
            <MetricCard icon={CheckCircle} label="Low Risk Recruiters" value={MOCK_RECRUITERS.filter(r => r.avgBias < 30).length} color="#10b981" delay={0.15} />
          </div>

          <div className="card" style={{ padding: 22 }}>
            <div className="section-label">DEPARTMENT × RECRUITER BIAS HEATMAP</div>
            <p style={{ fontSize: 12, color: "#475569", marginBottom: 16 }}>Color-coded grid: <span style={{ color: "#10b981" }}>Green</span> = Low · <span style={{ color: "#f59e0b" }}>Yellow</span> = Moderate · <span style={{ color: "#ef4444" }}>Red</span> = High Risk</p>

            {/* Column headers */}
            <div style={{ display: "grid", gridTemplateColumns: `160px repeat(${DEPARTMENTS.length}, 1fr)`, gap: 4, marginBottom: 4 }}>
              <div />
              {DEPARTMENTS.map(d => (
                <div key={d} style={{ fontSize: 10, color: "#475569", fontFamily: "JetBrains Mono", textAlign: "center", padding: "3px 0" }}>{d.slice(0, 6)}</div>
              ))}
            </div>

            {/* Heatmap rows */}
            {MOCK_RECRUITERS.map((rec, ri) => {
              const row = HEATMAP_DATA.find(h => h.recruiter === rec.name) || {};
              return (
                <div key={ri} style={{ display: "grid", gridTemplateColumns: `160px repeat(${DEPARTMENTS.length}, 1fr)`, gap: 4, marginBottom: 4 }}
                  className={selectedRecruiter.name === rec.name ? "" : ""}
                  onClick={() => setSelectedRecruiter(rec)}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, cursor: "pointer", padding: "0 6px" }}>
                    <div style={{ width: 24, height: 24, borderRadius: 6, background: `${riskColor(rec.avgBias)}20`, border: `1px solid ${riskColor(rec.avgBias)}40`, display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 }}>
                      <span style={{ fontSize: 10, fontWeight: 700, color: riskColor(rec.avgBias), fontFamily: "JetBrains Mono" }}>{rec.avgBias}</span>
                    </div>
                    <span style={{ fontSize: 12, color: selectedRecruiter.name === rec.name ? "#e2e8f0" : "#94a3b8", fontWeight: selectedRecruiter.name === rec.name ? 600 : 400, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{rec.name}</span>
                  </div>
                  {DEPARTMENTS.map(dept => {
                    const val = row[dept];
                    const color = val !== null && val !== undefined ? riskColor(val) : null;
                    return (
                      <div key={dept} className="heatmap-cell" style={{
                        height: 36,
                        background: val !== null && val !== undefined ? `${color}22` : "rgba(15,23,42,0.4)",
                        border: `1px solid ${val !== null && val !== undefined ? `${color}40` : "rgba(30,41,59,0.6)"}`,
                        color: color || "#334155",
                        boxShadow: val !== null && val !== undefined && val >= 60 ? `0 0 8px ${color}30` : "none",
                      }}>
                        {val !== null && val !== undefined ? val : "—"}
                      </div>
                    );
                  })}
                </div>
              );
            })}

            {/* Legend */}
            <div style={{ display: "flex", gap: 16, marginTop: 16, paddingTop: 14, borderTop: "1px solid rgba(99,102,241,0.1)" }}>
              {[["0–24", "#10b981", "Low Risk"], ["25–49", "#f59e0b", "Moderate"], ["50–74", "#ef4444", "High Risk"], ["75+", "#dc2626", "Critical"]].map(([range, color, label]) => (
                <div key={range} style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <div style={{ width: 16, height: 16, borderRadius: 3, background: `${color}20`, border: `1px solid ${color}60` }} />
                  <span style={{ fontSize: 11, color: "#64748b" }}>{range} — {label}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Selected Recruiter Detail */}
          {selectedRecruiter && (
            <div className="card slide-in-left" style={{ padding: 20 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                <div>
                  <div style={{ fontSize: 16, fontWeight: 700, color: "white" }}>{selectedRecruiter.name}</div>
                  <div style={{ fontSize: 12, color: "#64748b" }}>{selectedRecruiter.dept} · {selectedRecruiter.totalAudits} audits</div>
                </div>
                <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                  <span style={{ fontSize: 24, fontWeight: 800, color: riskColor(selectedRecruiter.avgBias), fontFamily: "JetBrains Mono" }}>{selectedRecruiter.avgBias}</span>
                  <div>
                    <div style={{ fontSize: 10, color: "#64748b", fontFamily: "JetBrains Mono" }}>AVG BIAS</div>
                    <Badge level={getTrend(selectedRecruiter.sessions)} label={trendLabel(getTrend(selectedRecruiter.sessions))} />
                  </div>
                </div>
              </div>
              <ResponsiveContainer width="100%" height={100}>
                <LineChart data={selectedRecruiter.sessions}>
                  <XAxis dataKey="week" tick={{ fill: "#64748b", fontSize: 10 }} stroke="#1e293b" />
                  <YAxis tick={{ fill: "#64748b", fontSize: 10 }} stroke="#1e293b" domain={[0, 100]} />
                  <Tooltip content={<TooltipContent />} />
                  <Line type="monotone" dataKey="score" name="Bias Score" stroke={riskColor(selectedRecruiter.avgBias)} strokeWidth={2.5} dot={{ r: 3 }} />
                </LineChart>
              </ResponsiveContainer>
            </div>
          )}
        </div>
      )}

      {/* ── B) RECRUITER TREND GRAPH ── */}
      {view === "trends" && (
        <div className="scale-in" style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">ALL RECRUITERS — BIAS SCORE TREND</div>
            <ResponsiveContainer width="100%" height={260}>
              <LineChart>
                <CartesianGrid strokeDasharray="3 3" stroke="rgba(99,102,241,0.07)" />
                <XAxis dataKey="week" type="category" allowDuplicatedCategory={false} stroke="#334155" tick={{ fill: "#64748b", fontSize: 11, fontFamily: "JetBrains Mono" }} />
                <YAxis stroke="#334155" tick={{ fill: "#64748b", fontSize: 11 }} domain={[0, 100]} />
                <Tooltip content={<TooltipContent />} />
                <Legend wrapperStyle={{ fontSize: 11, color: "#64748b", fontFamily: "JetBrains Mono" }} />
                <ReferenceLine y={50} stroke="rgba(239,68,68,0.3)" strokeDasharray="4 4" label={{ value: "Risk Threshold", fill: "#ef4444", fontSize: 10 }} />
                {MOCK_RECRUITERS.map((rec, i) => (
                  <Line key={rec.name} data={rec.sessions} type="monotone" dataKey="score" name={rec.name}
                    stroke={COLORS.chart[i % COLORS.chart.length]} strokeWidth={2}
                    dot={{ r: 3, fill: COLORS.chart[i % COLORS.chart.length] }} />
                ))}
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 14 }}>
            {MOCK_RECRUITERS.map((rec, i) => {
              const trend = getTrend(rec.sessions);
              const trendDir = trend === "improving" ? -1 : trend === "worsening" ? 1 : 0;
              const lastScore = rec.sessions[rec.sessions.length - 1]?.score || 0;
              const firstScore = rec.sessions[0]?.score || 0;
              const change = lastScore - firstScore;
              return (
                <div key={i} className="card card-elevated" style={{ padding: 16, cursor: "pointer" }} onClick={() => { setSelectedRecruiter(rec); setView("heatmap"); }}>
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
                    <div>
                      <div style={{ fontSize: 13, fontWeight: 600, color: "#e2e8f0" }}>{rec.name}</div>
                      <div style={{ fontSize: 11, color: "#475569" }}>{rec.dept}</div>
                    </div>
                    <Badge level={trend} label={trendLabel(trend)} />
                  </div>
                  <div style={{ display: "flex", gap: 12, marginBottom: 10 }}>
                    <div>
                      <div style={{ fontSize: 22, fontWeight: 800, color: riskColor(rec.avgBias), fontFamily: "JetBrains Mono" }}>{rec.avgBias}</div>
                      <div style={{ fontSize: 10, color: "#475569" }}>Avg Score</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 22, fontWeight: 800, color: change < 0 ? "#10b981" : change > 0 ? "#ef4444" : "#94a3b8", fontFamily: "JetBrains Mono" }}>{change > 0 ? "+" : ""}{change}</div>
                      <div style={{ fontSize: 10, color: "#475569" }}>8-Wk Change</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 22, fontWeight: 800, color: "#6366f1", fontFamily: "JetBrains Mono" }}>{rec.totalAudits}</div>
                      <div style={{ fontSize: 10, color: "#475569" }}>Audits</div>
                    </div>
                  </div>
                  <ResponsiveContainer width="100%" height={50}>
                    <LineChart data={rec.sessions}>
                      <Line type="monotone" dataKey="score" stroke={riskColor(rec.avgBias)} strokeWidth={2} dot={false} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* ── C) RECRUITER LEADERBOARD ── */}
      {view === "leaderboard" && (
        <div className="scale-in" style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          <div className="card" style={{ overflow: "hidden" }}>
            <div style={{ padding: "14px 20px 10px", borderBottom: "1px solid rgba(99,102,241,0.1)" }}>
              <div className="section-label" style={{ marginBottom: 0 }}>RECRUITER BIAS LEADERBOARD — RANKED BY LOWEST SCORE</div>
            </div>
            <div style={{ padding: "8px 0" }}>
              {sortedRecruiters.map((rec, i) => {
                const trend = getTrend(rec.sessions);
                const isTop3 = i < 3;
                const medals = ["🥇", "🥈", "🥉"];
                return (
                  <div key={i} className="slide-in-left" style={{ display: "flex", alignItems: "center", gap: 16, padding: "12px 20px", borderBottom: "1px solid rgba(99,102,241,0.06)", background: isTop3 ? "rgba(99,102,241,0.02)" : "transparent", transition: "background 0.2s", animationDelay: `${i * 0.06}s` }}
                    onMouseEnter={e => e.currentTarget.style.background = "rgba(99,102,241,0.05)"}
                    onMouseLeave={e => e.currentTarget.style.background = isTop3 ? "rgba(99,102,241,0.02)" : "transparent"}>
                    {/* Rank */}
                    <div style={{ width: 36, textAlign: "center", flexShrink: 0 }}>
                      {isTop3 ? (
                        <span style={{ fontSize: 20 }}>{medals[i]}</span>
                      ) : (
                        <span style={{ fontSize: 15, fontWeight: 700, color: "#334155", fontFamily: "JetBrains Mono" }}>#{i+1}</span>
                      )}
                    </div>
                    {/* Avatar */}
                    <div style={{ width: 38, height: 38, borderRadius: 10, background: `${riskColor(rec.avgBias)}18`, border: `1px solid ${riskColor(rec.avgBias)}35`, display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0, fontSize: 14, fontWeight: 700, color: riskColor(rec.avgBias) }}>
                      {rec.name.split(" ").map(n => n[0]).join("")}
                    </div>
                    {/* Info */}
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 14, fontWeight: 600, color: "#e2e8f0" }}>{rec.name}</div>
                      <div style={{ fontSize: 11, color: "#475569" }}>{rec.dept} · {rec.totalAudits} audits</div>
                    </div>
                    {/* Trend */}
                    <div style={{ textAlign: "center" }}>
                      <Badge level={trend} label={trendLabel(trend)} />
                    </div>
                    {/* Mini spark */}
                    <div style={{ width: 90 }}>
                      <ResponsiveContainer width="100%" height={30}>
                        <LineChart data={rec.sessions}>
                          <Line type="monotone" dataKey="score" stroke={riskColor(rec.avgBias)} strokeWidth={1.5} dot={false} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                    {/* Score */}
                    <div style={{ textAlign: "right", minWidth: 60 }}>
                      <div style={{ fontSize: 22, fontWeight: 800, color: riskColor(rec.avgBias), fontFamily: "JetBrains Mono" }}>{rec.avgBias}</div>
                      <div style={{ fontSize: 10, color: "#475569", fontFamily: "JetBrains Mono" }}>AVG BIAS</div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Department Summary */}
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">DEPARTMENT RISK SUMMARY</div>
            <ResponsiveContainer width="100%" height={180}>
              <BarChart data={MOCK_DEPT}>
                <CartesianGrid strokeDasharray="3 3" stroke="rgba(99,102,241,0.07)" />
                <XAxis dataKey="dept" tick={{ fill: "#64748b", fontSize: 11, fontFamily: "JetBrains Mono" }} stroke="#1e293b" />
                <YAxis tick={{ fill: "#64748b", fontSize: 11 }} stroke="#1e293b" domain={[0, 100]} />
                <Tooltip content={<TooltipContent />} />
                <Bar dataKey="score" name="Avg Bias Score" radius={[4, 4, 0, 0]}>
                  {MOCK_DEPT.map((d, i) => <Cell key={i} fill={riskColor(d.score)} />)}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      )}
    </div>
  );
};

// ─── TREND ANALYTICS ─────────────────────────────────────────────────────────
const TrendAnalytics = () => (
  <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
    <SectionHeader title="Trend Analytics" />
    <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr", gap: 20, marginBottom: 20 }}>
      <div className="card" style={{ padding: 20 }}>
        <div className="section-label">BIAS & FRAUD TREND (8 WEEKS)</div>
        <ResponsiveContainer width="100%" height={220}>
          <LineChart data={MOCK_TREND}>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(99,102,241,0.07)" />
            <XAxis dataKey="week" stroke="#334155" tick={{ fill: "#64748b", fontSize: 11, fontFamily: "JetBrains Mono" }} />
            <YAxis stroke="#334155" tick={{ fill: "#64748b", fontSize: 11 }} domain={[0, 100]} />
            <Tooltip content={<TooltipContent />} />
            <Legend wrapperStyle={{ fontSize: 11, color: "#64748b" }} />
            <Line type="monotone" dataKey="bias" name="Bias Score" stroke="#f59e0b" strokeWidth={2.5} dot={{ r: 4 }} />
            <Line type="monotone" dataKey="fraud" name="AI Fraud" stroke="#ef4444" strokeWidth={2} dot={{ r: 3 }} strokeDasharray="5 5" />
            <Line type="monotone" dataKey="risk" name="Overall Risk" stroke="#6366f1" strokeWidth={2} dot={{ r: 3 }} />
          </LineChart>
        </ResponsiveContainer>
      </div>
      <div className="card" style={{ padding: 20 }}>
        <div className="section-label">TOP 5 RECRUITERS</div>
        {[...MOCK_RECRUITERS].sort((a,b) => a.avgBias - b.avgBias).slice(0,5).map((r, i) => (
          <div key={i} style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
            <span style={{ fontSize: 12, color: "#475569", fontFamily: "JetBrains Mono", width: 18 }}>{i+1}</span>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 12, color: "#e2e8f0" }}>{r.name}</div>
              <div style={{ fontSize: 10, color: "#475569" }}>{r.dept}</div>
            </div>
            <span style={{ fontFamily: "JetBrains Mono", fontWeight: 700, color: riskColor(r.avgBias) }}>{r.avgBias}</span>
          </div>
        ))}
      </div>
    </div>
    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
      <div className="card" style={{ padding: 20 }}>
        <div className="section-label">DEPARTMENT RISK COMPARISON</div>
        <ResponsiveContainer width="100%" height={200}>
          <BarChart data={MOCK_DEPT} layout="vertical">
            <XAxis type="number" domain={[0,100]} tick={{ fill: "#64748b", fontSize: 10, fontFamily: "JetBrains Mono" }} stroke="#1e293b" />
            <YAxis type="category" dataKey="dept" tick={{ fill: "#64748b", fontSize: 11, fontFamily: "JetBrains Mono" }} stroke="#1e293b" width={80} />
            <Tooltip content={<TooltipContent />} />
            <Bar dataKey="score" name="Bias Score" radius={[0, 4, 4, 0]}>
              {MOCK_DEPT.map((d, i) => <Cell key={i} fill={riskColor(d.score)} />)}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      </div>
      <div className="card" style={{ padding: 20 }}>
        <div className="section-label">PREDICTIVE FORECAST</div>
        <ResponsiveContainer width="100%" height={200}>
          <AreaChart data={[...MOCK_TREND, { week: "W9", risk: 26 }, { week: "W10", risk: 22 }]}>
            <defs>
              <linearGradient id="fg" x1="0" y1="0" x2="0" y2="1">
                <stop offset="5%" stopColor="#10b981" stopOpacity={0.2} />
                <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
              </linearGradient>
            </defs>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(99,102,241,0.07)" />
            <XAxis dataKey="week" stroke="#334155" tick={{ fill: "#64748b", fontSize: 11, fontFamily: "JetBrains Mono" }} />
            <YAxis stroke="#334155" tick={{ fill: "#64748b", fontSize: 11 }} />
            <Tooltip content={<TooltipContent />} />
            <Area type="monotone" dataKey="risk" name="Risk (Forecast)" stroke="#10b981" fill="url(#fg)" strokeWidth={2} strokeDasharray="8 3" />
          </AreaChart>
        </ResponsiveContainer>
        <p style={{ fontSize: 11, color: "#10b981", marginTop: 6 }}>↓ On track to reach &lt;20 risk by W10</p>
      </div>
    </div>
  </div>
);

// ─── REPORTS ─────────────────────────────────────────────────────────────────
const Reports = ({ user }) => {
  const [generating, setGenerating] = useState(false);
  const [reports, setReports] = useState([
    { _id: "1", title: "Q4 2024 Executive Report", type: "Executive", fileSize: 248000, createdAt: new Date().toISOString() },
    { _id: "2", title: "November Bias Audit Report", type: "Interview", fileSize: 182000, createdAt: new Date(Date.now() - 86400000 * 15).toISOString() },
  ]);
  const [deletingId, setDeletingId] = useState(null);

  const generate = async () => {
    setGenerating(true);
    await new Promise(r => setTimeout(r, 1600));
    setReports(p => [{ _id: Date.now().toString(), title: `Executive Report — ${new Date().toLocaleDateString()}`, type: "Executive", fileSize: Math.floor(Math.random() * 200000 + 120000), createdAt: new Date().toISOString() }, ...p]);
    setGenerating(false);
  };

  const download = (report) => {
    const content = `HireGuard AI - ${report.title}\nGenerated: ${new Date().toLocaleString()}\n\nEXECUTIVE SUMMARY\nOverall Risk: 47/100 — Moderate\nTotal Interviews: 124\nCompliance Rate: 87%\nHigh Risk Incidents: 14\n`;
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([content], { type: "text/plain" })); a.download = `${report.title}.txt`; a.click();
  };

  const del = (id) => { setDeletingId(id); setTimeout(() => { setReports(p => p.filter(r => r._id !== id)); setDeletingId(null); }, 400); };

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Enterprise Reports">
        <button className="btn-primary" onClick={generate} disabled={generating} style={{ padding: "9px 18px", borderRadius: 9, fontSize: 13 }}>
          {generating ? <><Spinner size={14} /> Generating...</> : <><FileBarChart size={14} /> Generate Report</>}
        </button>
      </SectionHeader>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 16, marginBottom: 22 }}>
        <MetricCard icon={Shield} label="Overall Risk" value="47/100" color="#f59e0b" />
        <MetricCard icon={Users} label="Sessions" value="124" color="#6366f1" delay={0.05} />
        <MetricCard icon={CheckCircle} label="Compliance" value="87%" color="#10b981" delay={0.1} />
        <MetricCard icon={AlertTriangle} label="High Risk" value="14" color="#ef4444" delay={0.15} />
      </div>
      <div className="card" style={{ overflow: "hidden" }}>
        <div style={{ padding: "14px 20px", borderBottom: "1px solid rgba(99,102,241,0.1)" }}>
          <div className="section-label" style={{ marginBottom: 0 }}>GENERATED REPORTS</div>
        </div>
        <table className="table">
          <thead><tr><th>Title</th><th>Type</th><th>Size</th><th>Generated</th><th>Actions</th></tr></thead>
          <tbody>
            {reports.map(r => (
              <tr key={r._id}>
                <td style={{ fontWeight: 500, color: "#e2e8f0" }}>{r.title}</td>
                <td><Badge level="pending" label={r.type} /></td>
                <td style={{ fontFamily: "JetBrains Mono", fontSize: 12 }}>{(r.fileSize / 1024).toFixed(0)} KB</td>
                <td style={{ fontFamily: "JetBrains Mono", fontSize: 11, color: "#475569" }}>{new Date(r.createdAt).toLocaleDateString()}</td>
                <td>
                  <div style={{ display: "flex", gap: 6 }}>
                    <button className="btn-success" onClick={() => download(r)} style={{ padding: "5px 10px", borderRadius: 6, fontSize: 12 }}><Download size={12} /> Download</button>
                    <button className="btn-danger" onClick={() => del(r._id)} disabled={deletingId === r._id} style={{ padding: "5px 8px", borderRadius: 6, fontSize: 12 }}>{deletingId === r._id ? <Spinner size={12} /> : <Trash2 size={12} />}</button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// ─── ADMIN PANEL ──────────────────────────────────────────────────────────────
const AdminPanel = ({ user }) => {
  const [users, setUsers] = useState(MOCK_USERS);
  const [showModal, setShowModal] = useState(false);
  const [form, setForm] = useState({ name: "", email: "", password: "", role: "HR", department: "" });
  const [saving, setSaving] = useState(false);
  const [deletingId, setDeletingId] = useState(null);

  if (user.role !== "Admin") return (
    <div className="fade-up" style={{ height: "100%", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ textAlign: "center", color: "#475569" }}><Shield size={48} style={{ margin: "0 auto 16px", color: "#334155" }} /><p>Admin access required</p></div>
    </div>
  );

  const createUser = async () => {
    setSaving(true);
    await new Promise(r => setTimeout(r, 600));
    setUsers(p => [{ _id: Date.now().toString(), ...form, isActive: true, lastLogin: null, createdAt: new Date().toISOString() }, ...p]);
    setShowModal(false); setSaving(false);
    setForm({ name: "", email: "", password: "", role: "HR", department: "" });
  };

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Admin Panel">
        <button className="btn-primary" onClick={() => setShowModal(true)} style={{ padding: "9px 16px", borderRadius: 9, fontSize: 13 }}><Plus size={14} /> Add User</button>
      </SectionHeader>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 16, marginBottom: 22 }}>
        <MetricCard icon={Users} label="Total Users" value={users.length} color="#6366f1" />
        <MetricCard icon={Activity} label="Active Sessions" value="3" color="#10b981" delay={0.05} />
        <MetricCard icon={BarChart2} label="Total Audits" value="213" color="#f59e0b" delay={0.1} />
      </div>
      <div className="card" style={{ overflow: "hidden", marginBottom: 20 }}>
        <div style={{ padding: "12px 20px 10px", borderBottom: "1px solid rgba(99,102,241,0.1)" }}>
          <div className="section-label" style={{ marginBottom: 0 }}>USER MANAGEMENT</div>
        </div>
        <table className="table">
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Dept</th><th>Status</th><th>Last Login</th><th>Actions</th></tr></thead>
          <tbody>
            {users.map(u => (
              <tr key={u._id}>
                <td style={{ fontWeight: 500, color: "#e2e8f0" }}>{u.name}</td>
                <td style={{ fontFamily: "JetBrains Mono", fontSize: 11, color: "#94a3b8" }}>{u.email}</td>
                <td><Badge level={u.role === "Admin" ? "critical" : u.role === "HR" ? "moderate" : "low"} label={u.role} /></td>
                <td style={{ fontSize: 12 }}>{u.department || "—"}</td>
                <td><Badge level={u.isActive ? "reviewed" : "pending"} label={u.isActive ? "Active" : "Inactive"} /></td>
                <td style={{ fontFamily: "JetBrains Mono", fontSize: 11, color: "#475569" }}>{u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : "Never"}</td>
                <td>
                  <button className="btn-danger" onClick={() => { setDeletingId(u._id); setTimeout(() => { setUsers(p => p.filter(x => x._id !== u._id)); setDeletingId(null); }, 400); }} disabled={deletingId === u._id} style={{ padding: "5px 8px", borderRadius: 6, fontSize: 12 }}>
                    {deletingId === u._id ? <Spinner size={12} /> : <Trash2 size={12} />}
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal" style={{ padding: 28, width: 440 }} onClick={e => e.stopPropagation()}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 20 }}>
              <h3 style={{ fontSize: 17, fontWeight: 700, color: "white" }}>Create User</h3>
              <button onClick={() => setShowModal(false)} style={{ background: "none", border: "none", cursor: "pointer", color: "#64748b" }}><X size={18} /></button>
            </div>
            <div style={{ display: "flex", flexDirection: "column", gap: 14 }}>
              {[{ l: "Full Name", k: "name", ph: "John Smith" }, { l: "Email", k: "email", ph: "john@company.com", t: "email" }, { l: "Password", k: "password", ph: "••••••••", t: "password" }, { l: "Department", k: "department", ph: "Engineering" }].map(f => (
                <div key={f.k}>
                  <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>{f.l}</label>
                  <input className="input" type={f.t || "text"} value={form[f.k]} onChange={e => setForm(p => ({ ...p, [f.k]: e.target.value }))} placeholder={f.ph} style={{ width: "100%", borderRadius: 8, padding: "9px 12px", fontSize: 13 }} />
                </div>
              ))}
              <div>
                <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Role</label>
                <select className="input" value={form.role} onChange={e => setForm(p => ({ ...p, role: e.target.value }))} style={{ width: "100%", borderRadius: 8, padding: "9px 12px", fontSize: 13 }}>
                  {["Admin", "HR", "Auditor"].map(r => <option key={r}>{r}</option>)}
                </select>
              </div>
              <button className="btn-primary" onClick={createUser} disabled={saving} style={{ padding: "11px", borderRadius: 9, justifyContent: "center", width: "100%" }}>
                {saving ? <><Spinner size={14} /> Creating...</> : <><Plus size={14} /> Create User</>}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ─── SETTINGS ─────────────────────────────────────────────────────────────────
const SettingsPanel = ({ user, isDark, toggleTheme, onLogout }) => {
  const [notifications, setNotifications] = useState(true);
  const [autoSave, setAutoSave] = useState(true);
  const [liveMonitorDefault, setLiveMonitorDefault] = useState(false);
  const [saving, setSaving] = useState(false);

  const Toggle = ({ val, set, label, sub }) => (
    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "12px 0", borderBottom: "1px solid rgba(99,102,241,0.08)" }}>
      <div>
        <div style={{ fontSize: 13, color: "#94a3b8" }}>{label}</div>
        {sub && <div style={{ fontSize: 11, color: "#475569" }}>{sub}</div>}
      </div>
      <button onClick={() => set(!val)} className={`toggle-track ${val ? "toggle-live" : "toggle-off"}`}>
        <div className="toggle-thumb" style={{ left: val ? "calc(100% - 23px)" : "3px" }} />
      </button>
    </div>
  );

  return (
    <div className="fade-up" style={{ height: "100%", overflowY: "auto", padding: "24px 28px" }}>
      <SectionHeader title="Settings" />
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">PROFILE</div>
            <div style={{ display: "flex", alignItems: "center", gap: 14, marginBottom: 16, padding: 14, borderRadius: 10, background: "rgba(99,102,241,0.06)", border: "1px solid rgba(99,102,241,0.15)" }}>
              <div style={{ width: 44, height: 44, borderRadius: "50%", background: "linear-gradient(135deg, rgba(99,102,241,0.4), rgba(139,92,246,0.3))", display: "flex", alignItems: "center", justifyContent: "center", color: "#a5b4fc", fontWeight: 700, fontSize: 18, border: "1px solid rgba(99,102,241,0.4)" }}>
                {user.name[0]}
              </div>
              <div>
                <div style={{ fontSize: 14, color: "white", fontWeight: 600 }}>{user.name}</div>
                <div style={{ fontSize: 12, color: "#64748b" }}>{user.email}</div>
                <Badge level={user.role.toLowerCase()} label={user.role} />
              </div>
            </div>
            {[{ l: "Full Name", v: user.name }, { l: "Email", v: user.email }, { l: "Department", v: user.department || "Platform" }].map(f => (
              <div key={f.l} style={{ marginBottom: 12 }}>
                <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>{f.l}</label>
                <input className="input" defaultValue={f.v} style={{ width: "100%", borderRadius: 8, padding: "8px 12px", fontSize: 13 }} />
              </div>
            ))}
          </div>
        </div>
        <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">PLATFORM PREFERENCES</div>
            <Toggle val={isDark} set={toggleTheme} label="Dark Mode" />
            <Toggle val={notifications} set={setNotifications} label="Push Notifications" />
            <Toggle val={autoSave} set={setAutoSave} label="Auto-Save Audits" />
            <Toggle val={liveMonitorDefault} set={setLiveMonitorDefault} label="Live Monitoring Default On" sub="Start bias audit in live mode by default" />
            <div style={{ marginTop: 16, display: "flex", gap: 8 }}>
              <button className="btn-primary" onClick={async () => { setSaving(true); await new Promise(r => setTimeout(r, 800)); setSaving(false); }} disabled={saving} style={{ flex: 1, padding: "10px", borderRadius: 9, fontSize: 13, justifyContent: "center" }}>
                {saving ? <><Spinner size={14} /> Saving...</> : <><Save size={13} /> Save Preferences</>}
              </button>
            </div>
          </div>
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">API CONFIGURATION</div>
            <div style={{ marginBottom: 10 }}>
              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Backend URL</label>
              <input className="input" defaultValue={API_BASE} style={{ width: "100%", borderRadius: 8, padding: "8px 12px", fontSize: 12, fontFamily: "JetBrains Mono" }} />
            </div>
            <div>
              <label style={{ fontSize: 12, color: "#64748b", marginBottom: 5, display: "block" }}>Anthropic API Key</label>
              <input className="input" placeholder="sk-ant-..." type="password" style={{ width: "100%", borderRadius: 8, padding: "8px 12px", fontSize: 12, fontFamily: "JetBrains Mono" }} />
            </div>
            <p style={{ fontSize: 11, color: "#334155", marginTop: 8 }}>API key used for live monitoring + explainability</p>
          </div>
          <div className="card" style={{ padding: 20 }}>
            <div className="section-label">DANGER ZONE</div>
            <button className="btn-danger" onClick={onLogout} style={{ width: "100%", padding: "10px", borderRadius: 9, fontSize: 13, justifyContent: "center" }}>
              <LogOut size={13} /> Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ─── MAIN APP ─────────────────────────────────────────────────────────────────
export default function HireGuardAI() {
  const [auth, setAuth] = useState(null);
  const [page, setPage] = useState("dashboard");
  const [isDark, setIsDark] = useState(true);
  const [showNotifPanel, setShowNotifPanel] = useState(false);

  const navItems = [
    { id: "dashboard", icon: LayoutDashboard, label: "Dashboard" },
    { id: "bias", icon: Brain, label: "Interview Bias Audit", badge: "LIVE" },
    { id: "resume", icon: FileText, label: "Resume Intelligence", badge: "XAI" },
    { id: "skills", icon: Target, label: "Skill Match Engine" },
    { id: "recruiter", icon: UserCheck, label: "Recruiter Analytics", badge: "NEW" },
    { id: "analytics", icon: TrendingUp, label: "Trend Analytics" },
    { id: "reports", icon: FileBarChart, label: "Reports" },
    { id: "admin", icon: Users, label: "Admin Panel" },
    { id: "settings", icon: Settings, label: "Settings" },
  ];

  const pageComponents = {
    dashboard: <Dashboard user={auth?.user} />,
    bias: <InterviewBiasAudit user={auth?.user} token={auth?.token} />,
    resume: <ResumeIntelligence user={auth?.user} token={auth?.token} />,
    skills: <SkillMatchEngine user={auth?.user} />,
    recruiter: <RecruiterAnalytics user={auth?.user} />,
    analytics: <TrendAnalytics />,
    reports: <Reports user={auth?.user} />,
    admin: <AdminPanel user={auth?.user} />,
    settings: <SettingsPanel user={auth?.user} isDark={isDark} toggleTheme={() => setIsDark(!isDark)} onLogout={() => setAuth(null)} />,
  };

  if (!auth) return (
    <>
      <style>{GLOBAL_CSS}</style>
      <AuthScreen onLogin={(token, user) => setAuth({ token, user })} />
    </>
  );

  return (
    <>
      <style>{GLOBAL_CSS}</style>
      <div style={{ display: "flex", height: "100vh", background: isDark ? "#0B1426" : "#f1f5f9", overflow: "hidden" }}>
        {/* Background orbs */}
        <div style={{ position: "fixed", inset: 0, pointerEvents: "none", zIndex: 0 }}>
          <div style={{ position: "absolute", width: 800, height: 800, borderRadius: "50%", background: "radial-gradient(circle, rgba(99,102,241,0.04) 0%, transparent 70%)", top: "20%", left: "25%" }} />
          <div style={{ position: "absolute", width: 400, height: 400, borderRadius: "50%", background: "radial-gradient(circle, rgba(139,92,246,0.03) 0%, transparent 70%)", bottom: "10%", right: "15%" }} />
        </div>

        {/* Sidebar */}
        <div style={{ width: 228, background: "rgba(8,15,30,0.97)", borderRight: "1px solid rgba(99,102,241,0.12)", display: "flex", flexDirection: "column", position: "relative", zIndex: 10, flexShrink: 0 }}>
          <div style={{ padding: "18px 16px 14px", borderBottom: "1px solid rgba(99,102,241,0.1)" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 34, height: 34, borderRadius: 10, background: "linear-gradient(135deg, rgba(99,102,241,0.4), rgba(139,92,246,0.3))", border: "1px solid rgba(99,102,241,0.5)", display: "flex", alignItems: "center", justifyContent: "center", boxShadow: "0 0 20px rgba(99,102,241,0.2)", flexShrink: 0 }}>
                <Shield size={17} style={{ color: "#a5b4fc" }} />
              </div>
              <div>
                <div style={{ fontSize: 14, fontWeight: 800, color: "white", lineHeight: 1 }}>
                  <span className="gradient-text">HireGuard AI</span>
                </div>
                <div style={{ fontSize: 10, color: "#334155", fontFamily: "JetBrains Mono" }}>v2 · ENTERPRISE</div>
              </div>
            </div>
          </div>

          <nav style={{ flex: 1, padding: "12px 10px", overflowY: "auto" }}>
            <div style={{ fontSize: 10, color: "#334155", fontFamily: "JetBrains Mono", fontWeight: 600, letterSpacing: "0.1em", padding: "0 6px", marginBottom: 6 }}>PLATFORM</div>
            {navItems.slice(0, 7).map(item => (
              <div key={item.id} className={`sidebar-item ${page === item.id ? "active" : ""}`} onClick={() => setPage(item.id)} style={{ marginBottom: 2 }}>
                <item.icon size={14} />
                <span style={{ flex: 1 }}>{item.label}</span>
                {item.badge && (
                  <span style={{ fontSize: 8, fontWeight: 700, padding: "1px 5px", borderRadius: 4, background: item.badge === "NEW" ? "rgba(16,185,129,0.2)" : item.badge === "LIVE" ? "rgba(239,68,68,0.2)" : "rgba(139,92,246,0.2)", color: item.badge === "NEW" ? "#10b981" : item.badge === "LIVE" ? "#ef4444" : "#c4b5fd", border: `1px solid ${item.badge === "NEW" ? "rgba(16,185,129,0.4)" : item.badge === "LIVE" ? "rgba(239,68,68,0.4)" : "rgba(139,92,246,0.4)"}`, fontFamily: "JetBrains Mono", letterSpacing: "0.04em" }}>
                    {item.badge}
                  </span>
                )}
                {page === item.id && <ChevronRight size={11} style={{ opacity: 0.6 }} />}
              </div>
            ))}
            <div style={{ fontSize: 10, color: "#334155", fontFamily: "JetBrains Mono", fontWeight: 600, letterSpacing: "0.1em", padding: "12px 6px 6px", marginTop: 4 }}>SYSTEM</div>
            {navItems.slice(7).map(item => (
              <div key={item.id} className={`sidebar-item ${page === item.id ? "active" : ""}`} onClick={() => setPage(item.id)} style={{ marginBottom: 2 }}>
                <item.icon size={14} /><span>{item.label}</span>
              </div>
            ))}
          </nav>

          {/* User footer */}
          <div style={{ padding: "12px 14px", borderTop: "1px solid rgba(99,102,241,0.1)" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 30, height: 30, borderRadius: 8, background: "linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.2))", display: "flex", alignItems: "center", justifyContent: "center", color: "#a5b4fc", fontSize: 13, fontWeight: 700, flexShrink: 0 }}>
                {auth.user.name[0]}
              </div>
              <div style={{ flex: 1, minWidth: 0 }}>
                <div style={{ fontSize: 12, color: "#e2e8f0", fontWeight: 600, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{auth.user.name}</div>
                <div style={{ fontSize: 10, color: "#475569" }}>{auth.user.role}</div>
              </div>
              <button onClick={() => setAuth(null)} style={{ background: "none", border: "none", cursor: "pointer", color: "#475569", padding: 4 }} title="Logout">
                <LogOut size={13} />
              </button>
            </div>
          </div>
        </div>

        {/* Main Area */}
        <div style={{ flex: 1, display: "flex", flexDirection: "column", overflow: "hidden", position: "relative", zIndex: 1 }}>
          {/* Header */}
          <div style={{ height: 56, background: "rgba(8,15,30,0.92)", borderBottom: "1px solid rgba(99,102,241,0.1)", display: "flex", alignItems: "center", justifyContent: "space-between", padding: "0 24px", backdropFilter: "blur(12px)", flexShrink: 0 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              {(() => {
                const item = navItems.find(n => n.id === page);
                if (!item) return null;
                const Icon = item.icon;
                return (
                  <>
                    <Icon size={15} style={{ color: "#6366f1" }} />
                    <span style={{ fontSize: 14, fontWeight: 600, color: "#e2e8f0" }}>{item.label}</span>
                    {item.badge && <span style={{ fontSize: 9, fontWeight: 700, padding: "2px 6px", borderRadius: 4, background: item.badge === "NEW" ? "rgba(16,185,129,0.15)" : item.badge === "LIVE" ? "rgba(239,68,68,0.15)" : "rgba(139,92,246,0.15)", color: item.badge === "NEW" ? "#10b981" : item.badge === "LIVE" ? "#ef4444" : "#c4b5fd", border: `1px solid ${item.badge === "NEW" ? "rgba(16,185,129,0.3)" : item.badge === "LIVE" ? "rgba(239,68,68,0.3)" : "rgba(139,92,246,0.3)"}`, fontFamily: "JetBrains Mono" }}>{item.badge}</span>}
                  </>
                );
              })()}
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ position: "relative" }}>
                <Search size={13} style={{ position: "absolute", left: 10, top: "50%", transform: "translateY(-50%)", color: "#475569" }} />
                <input className="input" placeholder="Search..." style={{ width: 200, borderRadius: 8, padding: "6px 12px 6px 30px", fontSize: 12 }} />
              </div>
              <button onClick={() => setShowNotifPanel(!showNotifPanel)} style={{ width: 34, height: 34, borderRadius: 9, background: "rgba(15,23,42,0.8)", border: "1px solid rgba(99,102,241,0.2)", cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", position: "relative", color: "#64748b" }}>
                <Bell size={15} />
                <div className="notification-dot" />
              </button>
              <div style={{ width: 34, height: 34, borderRadius: 9, background: "linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.2))", display: "flex", alignItems: "center", justifyContent: "center", color: "#a5b4fc", fontWeight: 700, fontSize: 14, border: "1px solid rgba(99,102,241,0.3)", cursor: "pointer" }}>
                {auth.user.name[0]}
              </div>
            </div>
          </div>

          {/* Notification Panel */}
          {showNotifPanel && (
            <div style={{ position: "absolute", top: 60, right: 16, width: 300, zIndex: 50 }} className="scale-in">
              <div className="glass-bright" style={{ borderRadius: 14, padding: 16, boxShadow: "0 20px 60px rgba(0,0,0,0.5)" }}>
                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 12 }}>
                  <span style={{ fontSize: 11, color: "#64748b", fontFamily: "JetBrains Mono", fontWeight: 600 }}>NOTIFICATIONS</span>
                  <button onClick={() => setShowNotifPanel(false)} style={{ background: "none", border: "none", cursor: "pointer", color: "#475569" }}><X size={14} /></button>
                </div>
                {[
                  { msg: "High bias alert: Interview #482 — Sarah Kim", time: "2m ago", color: "#ef4444" },
                  { msg: "Resume fraud detected: Candidate J. Doe", time: "15m ago", color: "#f59e0b" },
                  { msg: "Live monitoring flagged 3 issues", time: "32m ago", color: "#6366f1" },
                  { msg: "Q4 Compliance report generated", time: "1h ago", color: "#10b981" },
                ].map((n, i) => (
                  <div key={i} style={{ display: "flex", gap: 10, padding: "7px 0", borderBottom: "1px solid rgba(99,102,241,0.07)" }}>
                    <div style={{ width: 7, height: 7, borderRadius: "50%", background: n.color, marginTop: 4, flexShrink: 0 }} />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 12, color: "#e2e8f0" }}>{n.msg}</div>
                      <div style={{ fontSize: 10, color: "#475569", fontFamily: "JetBrains Mono", marginTop: 1 }}>{n.time}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Page Content */}
          <div style={{ flex: 1, overflow: "hidden" }} onClick={() => showNotifPanel && setShowNotifPanel(false)}>
            {pageComponents[page]}
          </div>
        </div>
      </div>
    </>
  );
}